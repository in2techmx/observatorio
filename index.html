<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligence Stream | Observatorio Geopolítico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #05070a; --card-bg: #0f1219; --accent: #00f2ff; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 50px; }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        .news-card {
            min-width: 320px;
            max-width: 320px;
            height: 200px;
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .news-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.1);
        }

        .pct-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            font-family: 'JetBrains Mono';
            font-size: 14px;
            font-weight: 900;
        }

        .category-row {
            border-left: 4px solid var(--accent);
            padding-left: 20px;
            margin-bottom: 10px;
        }

        #side-panel {
            transition: 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            background: rgba(5, 7, 10, 0.98);
            backdrop-filter: blur(30px);
        }

        .cyber-header {
            background: linear-gradient(to bottom, rgba(0, 242, 255, 0.05), transparent);
            border-bottom: 1px solid rgba(0, 242, 255, 0.1);
        }
    </style>
</head>
<body>

    <header class="cyber-header p-8 mb-10 flex justify-between items-center sticky top-0 z-40 backdrop-blur-md">
        <div>
            <h1 class="text-2xl font-black tracking-tighter italic uppercase text-white">Intelligence <span class="text-cyan-400">Stream</span></h1>
            <p id="stats" class="text-[10px] font-mono text-slate-500 mt-1 uppercase tracking-widest">Sincronizando flujo de datos...</p>
        </div>
        <button onclick="exportBriefing()" class="px-4 py-2 border border-cyan-500/30 text-cyan-400 text-[10px] font-bold uppercase tracking-widest hover:bg-cyan-500 hover:text-black transition-all">
            Descargar Reporte TXT
        </button>
    </header>

    <main id="main-content" class="px-8 space-y-16">
        </main>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[600px] z-50 translate-x-full border-l border-white/10 p-12 overflow-y-auto">
        <button onclick="closePanel()" class="mb-12 text-cyan-500 hover:text-white text-[11px] font-black uppercase tracking-[0.5em]">
            ← VOLVER AL STREAM
        </button>
        <div id="panel-content"></div>
    </aside>

    <script>
        const BLOQUE_COLORS = {"USA": "#3b82f6", "Europa": "#fde047", "Rusia": "#ef4444", "China": "#f97316", "LATAM": "#d946ef", "Medio Oriente": "#10b981", "África": "#8b5cf6"};

        async function init() {
            try {
                const data = await d3.json("./latest_news.json?v=" + Date.now());
                const container = document.getElementById('main-content');
                let total = 0;

                data.categorias.forEach(cat => {
                    if (cat.particulas && cat.particulas.length > 0) {
                        total += cat.particulas.length;
                        
                        // Crear la Fila (Row)
                        const row = document.createElement('section');
                        row.className = 'space-y-4';
                        row.innerHTML = `
                            <div class="category-row">
                                <h2 class="text-xs font-black uppercase tracking-[0.3em] text-slate-400">${cat.nombre}</h2>
                                <p class="text-[10px] text-slate-600 mt-1 italic">${cat.consenso}</p>
                            </div>
                            <div class="flex gap-6 overflow-x-auto pb-6 hide-scroll px-2" id="row-${cat.nombre.replace(/\s+/g, '')}">
                                </div>
                        `;
                        container.appendChild(row);

                        const rowContent = document.getElementById(`row-${cat.nombre.replace(/\s+/g, '')}`);
                        
                        cat.particulas.forEach(p => {
                            const card = document.createElement('div');
                            card.className = 'news-card p-6 flex flex-col justify-between group';
                            card.onclick = () => openPanel({...p, catName: cat.nombre, consensus: cat.consenso});
                            
                            // Determinamos color de proximidad
                            const pctColor = p.proximidad > 70 ? '#00f2ff' : (p.proximidad > 40 ? '#fde047' : '#ef4444');

                            card.innerHTML = `
                                <div class="pct-badge" style="color: ${pctColor}">${p.proximidad}%</div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2" style="background: ${p.color_bloque}"></div>
                                        <span class="text-[9px] font-bold uppercase tracking-widest text-slate-400">${p.bloque}</span>
                                    </div>
                                    <h3 class="text-lg font-black leading-tight text-white group-hover:text-cyan-400 transition-colors line-clamp-3">${p.titulo}</h3>
                                </div>
                                <div class="text-[9px] font-mono text-slate-600 uppercase tracking-widest">Click para análisis profundo</div>
                            `;
                            rowContent.appendChild(card);
                        });
                    }
                });

                document.getElementById('stats').innerText = `${total} NODOS DE INTELIGENCIA ACTIVOS`;

            } catch (e) { console.error(e); }
        }

        function openPanel(d) {
            document.getElementById('panel-content').innerHTML = `
                <div class="flex justify-between items-start mb-12">
                    <div style="background:${d.color_bloque}" class="px-4 py-1 text-xs font-black text-black uppercase tracking-widest">${d.bloque}</div>
                    <div class="text-right">
                        <div class="text-[10px] font-mono text-slate-500 uppercase">Convergencia Regional</div>
                        <div class="text-5xl font-black text-white">${d.proximidad}%</div>
                    </div>
                </div>
                
                <h2 class="text-4xl font-black text-white mb-8 leading-tight uppercase tracking-tighter">${d.titulo}</h2>
                
                <div class="space-y-10">
                    <div>
                        <h4 class="text-xs font-bold text-cyan-400 uppercase tracking-widest mb-4">Análisis del Bloque</h4>
                        <p class="text-2xl text-slate-200 font-light leading-snug">${d.analisis_regional}</p>
                    </div>
                    
                    <div class="p-8 bg-white/5 border-l-4 border-slate-700">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase mb-2">Consenso en ${d.catName}</h4>
                        <p class="text-sm text-slate-400 italic font-serif leading-relaxed">"${d.consensus}"</p>
                    </div>

                    <a href="${d.link}" target="_blank" class="block w-full text-center py-5 bg-cyan-500 text-black font-black uppercase text-xs tracking-[0.3em] hover:bg-white transition-all">
                        ABRIR FUENTE ORIGINAL [RSS FEED]
                    </a>
                </div>
            `;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        function closePanel() { document.getElementById('side-panel').classList.add('translate-x-full'); }
        
        async function exportBriefing() {
            const data = await d3.json("./latest_news.json?v=" + Date.now());
            let report = `BRIEFING STREAM - ${new Date().toLocaleDateString()}\n\n`;
            data.categorias.forEach(cat => {
                report += `[ ${cat.nombre.toUpperCase()} ]\n`;
                cat.particulas.forEach(p => report += `- ${p.bloque} (${p.proximidad}%): ${p.titulo}\n`);
                report += `\n`;
            });
            const blob = new Blob([report], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = `Briefing_Stream.txt`; a.click();
        }

        init();
    </script>
</body>
</html>
