<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Proximity | Radar System</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        #universe { background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.03) 1px, transparent 0); background-size: 40px 40px; }
        .orbit-path { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 0.5; stroke-dasharray: 2,4; }
        .label-cat { font-family: 'JetBrains Mono', monospace; font-size: 10px; fill: #94a3b8; font-weight: bold; letter-spacing: 0.3em; pointer-events: none; }
        .label-pct { font-family: 'JetBrains Mono', monospace; font-size: 7px; fill: #334155; pointer-events: none; }
        #side-panel { transition: 0.8s cubic-bezier(0.16, 1, 0.3, 1); background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(40px); border-left: 1px solid rgba(255,255,255,0.1); }
        .particle { cursor: pointer; transition: all 0.3s ease; }
        .particle:hover { filter: brightness(1.5) scale(1.1); }
        .sun-core { filter: blur(15px); opacity: 0.4; }
        
        /* Estilos para la tabla de guía */
        .guide-table th { text-align: left; font-size: 8px; color: #64748b; padding-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .guide-table td { font-size: 10px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
    </style>
</head>
<body>

    <div id="universe" class="w-screen h-screen relative">
        <header class="absolute top-10 left-10 z-10">
            <h1 class="text-xl font-black tracking-tighter italic text-white/90">ORBITAL INTELLIGENCE</h1>
            <div class="flex items-center gap-3 mt-1">
                <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 bg-sky-500 rounded-full animate-pulse"></div>
                    <span id="news-count" class="text-[9px] font-mono text-sky-400 font-bold uppercase tracking-widest">Calculando radar...</span>
                </div>
            </div>
        </header>

        <div class="absolute bottom-10 right-10 z-20 bg-black/60 backdrop-blur-xl p-6 border border-white/10 rounded-sm w-[320px]">
            <h4 class="text-[9px] font-mono text-sky-500 font-bold uppercase tracking-[0.3em] mb-4">Guía de Referencia</h4>
            
            <table class="w-full guide-table mb-6">
                <thead><tr><th colspan="2">Bloques Geopolíticos</th></tr></thead>
                <tbody id="legend-items"></tbody>
            </table>

            <table class="w-full guide-table">
                <thead><tr><th colspan="2">Escala de Proximidad (%)</th></tr></thead>
                <tbody>
                    <tr><td class="w-12 text-white font-bold">100%</td><td class="text-slate-400">Centro: Convergencia Total / Consenso Global.</td></tr>
                    <tr><td class="text-white font-bold">75%</td><td class="text-slate-400">Alineación moderada con matices regionales.</td></tr>
                    <tr><td class="text-white font-bold">50%</td><td class="text-slate-400">Equilibrio entre consenso y visión propia.</td></tr>
                    <tr><td class="text-white font-bold">25%</td><td class="text-slate-400">Divergencia significativa / Sesgo del bloque.</td></tr>
                    <tr><td class="text-white font-bold">0%</td><td class="text-slate-400">Periferia: Ruptura narrativa o conflicto.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[500px] z-50 translate-x-full p-10 overflow-y-auto">
        <button onclick="closePanel()" class="mb-12 text-slate-500 hover:text-white transition-all text-[9px] font-bold tracking-[0.5em]">
            [ CLOSE ANALYSIS ]
        </button>
        <div id="panel-content"></div>
    </aside>

    <script>
        const width = window.innerWidth, height = window.innerHeight;
        const svg = d3.select("#universe").append("svg").attr("width", width).attr("height", height);
        const BLOQUE_COLORS = {"USA": "#3b82f6", "Europa": "#fde047", "Rusia": "#ef4444", "China": "#f97316", "LATAM": "#d946ef", "Medio Oriente": "#10b981", "África": "#8b5cf6"};

        async function init() {
            try {
                const data = await d3.json("./latest_news.json?v=" + Date.now());
                
                // 1. Llenar tabla de bloques
                const legend = document.getElementById('legend-items');
                Object.entries(BLOQUE_COLORS).forEach(([name, color]) => {
                    legend.innerHTML += `<tr><td class="w-4"><div class="w-2 h-2" style="background:${color}"></div></td><td class="text-slate-300 uppercase tracking-widest text-[9px]">${name}</td></tr>`;
                });

                const centers = {
                    "Seguridad y Conflictos": {x: width * 0.25, y: height * 0.35, color: "#f43f5e"},
                    "Economía y Sanciones":   {x: width * 0.50, y: height * 0.55, color: "#fbbf24"},
                    "Energía y Recursos":    {x: width * 0.75, y: height * 0.35, color: "#22c55e"},
                    "Soberanía y Alianzas":  {x: width * 0.35, y: height * 0.75, color: "#a855f7"},
                    "Tecnología y Espacio":  {x: width * 0.65, y: height * 0.75, color: "#0ea5e9"}
                };

                const MAX_RADIUS = 150;
                let totalParticles = 0;

                Object.keys(centers).forEach(catName => {
                    const c = centers[catName];
                    const catData = data.categorias.find(cat => cat.nombre === catName);

                    // Anillos de porcentaje
                    [0.25, 0.5, 0.75].forEach(r => {
                        svg.append("circle").attr("cx", c.x).attr("cy", c.y).attr("r", MAX_RADIUS * r).attr("class", "orbit-path");
                        svg.append("text").attr("x", c.x + (MAX_RADIUS * r)).attr("y", c.y - 4).attr("class", "label-pct").text(`${Math.round((1-r)*100)}%`);
                    });

                    // Centro (100%)
                    svg.append("circle").attr("cx", c.x).attr("cy", c.y).attr("r", 15).attr("fill", c.color).attr("class", "sun-core");
                    svg.append("text").attr("x", c.x).attr("y", c.y + MAX_RADIUS + 35).attr("text-anchor", "middle").attr("class", "label-cat").text(catName);

                    if(catData && catData.particulas) {
                        totalParticles += catData.particulas.length;
                        catData.particulas.forEach((p, i) => {
                            const angle = (i / catData.particulas.length) * (2 * Math.PI);
                            // Mapeo: 100% proximidad -> Radio 25 | 0% proximidad -> Radio MAX_RADIUS
                            const rPos = MAX_RADIUS - (p.proximidad * (MAX_RADIUS / 100)) + 25;
                            const px = c.x + rPos * Math.cos(angle);
                            const py = c.y + rPos * Math.sin(angle);

                            const g = svg.append("g").attr("class", "particle").attr("transform", `translate(${px},${py})`)
                                .on("click", () => openPanel({...p, consensus: catData.consenso, catColor: c.color}));

                            g.append("circle").attr("r", 6 + (p.proximidad / 12)).attr("fill", p.color_bloque).attr("stroke", "#fff").attr("stroke-width", 0.5)
                                .style("filter", `drop-shadow(0 0 10px ${p.color_bloque}88)`);
                        });
                    }
                });

                document.getElementById('news-count').innerText = `${totalParticles} Partículas en Análisis`;

            } catch (err) { console.error("Error cargando el radar:", err); }
        }

        function openPanel(d) {
            document.getElementById('panel-content').innerHTML = `
                <div class="animate-in fade-in slide-in-from-right duration-500">
                    <div class="flex justify-between items-center mb-8">
                        <span style="background:${d.color_bloque}" class="text-[9px] font-black px-2 py-1 text-black uppercase tracking-widest">${d.bloque}</span>
                        <span class="font-mono text-2xl font-bold text-white">${d.proximidad}%</span>
                    </div>
                    <h2 class="text-2xl font-extrabold leading-tight text-white mb-6">${d.titulo}</h2>
                    <div class="space-y-6">
                        <p class="text-lg leading-relaxed text-slate-200 font-light">${d.analisis_regional}</p>
                        <div class="bg-white/5 p-4 border-l-2" style="border-color:${d.catColor}">
                            <h4 class="text-[9px] uppercase tracking-[0.3em] text-slate-500 mb-2">Consenso Global</h4>
                            <p class="text-xs text-slate-400 italic font-serif">"${d.consensus}"</p>
                        </div>
                        <a href="${d.link}" target="_blank" class="block p-4 bg-white/5 hover:bg-sky-500/10 transition-all rounded border border-white/5 text-[10px] text-sky-400 font-bold tracking-widest">ORIGINAL SOURCE ↗</a>
                    </div>
                </div>`;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        function closePanel() { document.getElementById('side-panel').classList.add('translate-x-full'); }
        init();
        window.addEventListener('resize', () => location.reload());
    </script>
</body>
</html>
