<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Intelligence | Strategic Radar</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #02040a; --accent: #0ea5e9; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        
        #universe {
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(14, 165, 233, 0.05) 0%, transparent 70%),
                radial-gradient(circle at 2px 2px, rgba(255,255,255,0.02) 1px, transparent 0);
            background-size: 100% 100%, 30px 30px;
        }

        /* Estilo de los anillos del Radar */
        .radar-line { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 1; }
        .radar-grid { fill: none; stroke: rgba(255,255,255,0.02); stroke-width: 0.5; stroke-dasharray: 4,4; }
        
        /* Efecto Glow para part√≠culas */
        .particle { cursor: pointer; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .particle:hover { filter: brightness(1.8) drop-shadow(0 0 15px currentColor); }

        .label-cat { font-family: 'JetBrains Mono', monospace; font-size: 11px; fill: #475569; font-weight: 700; letter-spacing: 0.5em; text-transform: uppercase; }
        .label-pct { font-family: 'JetBrains Mono', monospace; font-size: 8px; fill: #1e293b; }

        /* Paneles */
        .glass-panel { background: rgba(3, 7, 18, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        #side-panel { transition: 0.8s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -20px 0 60px rgba(0,0,0,0.8); }
        
        /* Animaci√≥n de entrada */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .radar-group { animation: fadeIn 1.2s ease-out forwards; }
    </style>
</head>
<body>

    <div id="universe" class="w-screen h-screen relative">
        <header class="absolute top-8 left-8 z-30 flex flex-col gap-5">
            <div>
                <h1 class="text-2xl font-black tracking-[ -0.05em] italic text-white leading-none">STRATEGIC <span class="text-sky-500">ORBIT</span></h1>
                <div class="flex items-center gap-3 mt-2">
                    <span id="news-count" class="text-[10px] font-mono bg-sky-500/10 text-sky-400 px-2 py-0.5 border border-sky-500/20">Sincronizando...</span>
                </div>
            </div>
            <button onclick="exportBriefing()" class="w-fit px-4 py-2 glass-panel text-[9px] font-mono text-slate-400 uppercase tracking-widest hover:text-white hover:bg-white/5 transition-all">
                üíæ Export Briefing .TXT
            </button>
        </header>

        <div class="absolute bottom-8 right-8 z-30 glass-panel p-6 w-80">
            <h4 class="text-[9px] font-mono text-sky-500 font-bold uppercase tracking-[0.3em] mb-5">Technical Reference</h4>
            
            <div class="space-y-6">
                <div>
                    <div class="grid grid-cols-2 gap-2" id="legend-items"></div>
                </div>
                
                <div class="pt-4 border-t border-white/5">
                    <div class="flex justify-between text-[8px] font-mono text-slate-500 mb-2 uppercase tracking-widest">
                        <span>Divergencia</span>
                        <span>Consenso</span>
                    </div>
                    <div class="h-1.5 w-full bg-gradient-to-r from-slate-900 via-slate-700 to-sky-500 rounded-full"></div>
                    <div class="flex justify-between text-[10px] mt-2 text-slate-400 font-bold">
                        <span>0%</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[550px] z-50 translate-x-full glass-panel p-12 overflow-y-auto">
        <button onclick="closePanel()" class="mb-16 text-slate-500 hover:text-white transition-all text-[10px] font-bold tracking-[0.5em] flex items-center gap-2">
            <span class="text-lg">‚Üê</span> CLOSE COMMAND
        </button>
        <div id="panel-content"></div>
    </aside>

    <script>
        const width = window.innerWidth, height = window.innerHeight;
        const svg = d3.select("#universe").append("svg").attr("width", width).attr("height", height);
        const BLOQUE_COLORS = {"USA": "#3b82f6", "Europa": "#fde047", "Rusia": "#ef4444", "China": "#f97316", "LATAM": "#d946ef", "Medio Oriente": "#10b981", "√Åfrica": "#8b5cf6"};

        async function init() {
            try {
                const data = await d3.json("./latest_news.json?v=" + Date.now());
                
                // 1. Leyenda Din√°mica
                const legend = document.getElementById('legend-items');
                Object.entries(BLOQUE_COLORS).forEach(([name, color]) => {
                    legend.innerHTML += `<div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background:${color}; box-shadow: 0 0 8px ${color}66"></div><span class="text-[9px] font-mono text-slate-400 uppercase tracking-widest">${name}</span></div>`;
                });

                const centers = {
                    "Seguridad y Conflictos": {x: width * 0.28, y: height * 0.35, color: "#f43f5e"},
                    "Econom√≠a y Sanciones":   {x: width * 0.50, y: height * 0.55, color: "#fbbf24"},
                    "Energ√≠a y Recursos":    {x: width * 0.72, y: height * 0.35, color: "#22c55e"},
                    "Soberan√≠a y Alianzas":  {x: width * 0.35, y: height * 0.78, color: "#a855f7"},
                    "Tecnolog√≠a y Espacio":  {x: width * 0.65, y: height * 0.78, color: "#0ea5e9"}
                };

                const MAX_RADIUS = 160;
                let totalParticles = 0;

                Object.keys(centers).forEach(catName => {
                    const c = centers[catName];
                    const catData = data.categorias.find(cat => cat.nombre === catName);
                    const radarGroup = svg.append("g").attr("class", "radar-group");

                    // Dibujar rejilla de radar (L√≠neas cruzadas)
                    [0, 45, 90, 135].forEach(angle => {
                        radarGroup.append("line")
                            .attr("x1", c.x - MAX_RADIUS).attr("y1", c.y)
                            .attr("x2", c.x + MAX_RADIUS).attr("y2", c.y)
                            .attr("class", "radar-grid")
                            .attr("transform", `rotate(${angle}, ${c.x}, ${c.y})`);
                    });

                    // Dibujar anillos (25, 50, 75, 100%)
                    [0.25, 0.5, 0.75, 1].forEach(r => {
                        radarGroup.append("circle")
                            .attr("cx", c.x).attr("cy", c.y).attr("r", MAX_RADIUS * r)
                            .attr("class", "radar-line");
                    });

                    // N√∫cleo brillante
                    radarGroup.append("circle")
                        .attr("cx", c.x).attr("cy", c.y).attr("r", 8)
                        .attr("fill", c.color)
                        .style("filter", `blur(8px)`)
                        .style("opacity", 0.6);
                    
                    radarGroup.append("circle")
                        .attr("cx", c.x).attr("cy", c.y).attr("r", 3)
                        .attr("fill", "#fff");

                    radarGroup.append("text")
                        .attr("x", c.x).attr("y", c.y + MAX_RADIUS + 35)
                        .attr("text-anchor", "middle").attr("class", "label-cat").text(catName);

                    // Part√≠culas
                    if(catData && catData.particulas) {
                        totalParticles += catData.particulas.length;
                        catData.particulas.forEach((p, i) => {
                            const angle = (i / catData.particulas.length) * (2 * Math.PI) - Math.PI/2;
                            // El radio es inverso: 100% proximidad = Radio peque√±o
                            const rPos = MAX_RADIUS - (p.proximidad * (MAX_RADIUS / 100)) + 15;
                            const px = c.x + rPos * Math.cos(angle);
                            const py = c.y + rPos * Math.sin(angle);

                            const g = radarGroup.append("g")
                                .attr("class", "particle")
                                .attr("transform", `translate(${px},${py})`)
                                .on("click", () => openPanel({...p, consensus: catData.consenso, catColor: c.color}));

                            g.append("circle")
                                .attr("r", 5 + (p.proximidad / 15))
                                .attr("fill", p.color_bloque)
                                .style("filter", `drop-shadow(0 0 8px ${p.color_bloque})`);
                            
                            // Punto blanco central en la part√≠cula
                            g.append("circle").attr("r", 1.5).attr("fill", "#fff").style("opacity", 0.8);
                        });
                    }
                });

                document.getElementById('news-count').innerText = `${totalParticles} NODOS ACTIVOS`;

            } catch (err) { console.error(err); }
        }

        function openPanel(d) {
            const content = document.getElementById('panel-content');
            content.innerHTML = `
                <div class="animate-in fade-in slide-in-from-right duration-700">
                    <div class="flex justify-between items-start mb-12">
                        <div style="background:${d.color_bloque}" class="px-3 py-1 text-[10px] font-black text-black uppercase tracking-widest">${d.bloque}</div>
                        <div class="text-right">
                            <div class="text-[9px] font-mono text-slate-500 uppercase tracking-widest mb-1">Convergence Index</div>
                            <div class="text-4xl font-black text-white">${d.proximidad}%</div>
                        </div>
                    </div>

                    <h2 class="text-3xl font-black leading-tight text-white mb-8">${d.titulo}</h2>
                    
                    <div class="space-y-10">
                        <div>
                            <h4 class="text-[10px] font-mono text-sky-500 font-bold uppercase tracking-[0.4em] mb-4">Regional Narrative Analysis</h4>
                            <p class="text-xl leading-relaxed text-slate-300 font-light">${d.analisis_regional}</p>
                        </div>

                        <div class="p-6 border-l-4 bg-white/5" style="border-color:${d.catColor}">
                            <h4 class="text-[10px] font-mono text-slate-500 uppercase tracking-[0.4em] mb-3">Global Consensus</h4>
                            <p class="text-sm text-slate-400 italic leading-relaxed font-serif">"${d.consensus}"</p>
                        </div>

                        <div class="pt-10 border-t border-white/5">
                            <a href="${d.link}" target="_blank" class="flex justify-between items-center group">
                                <span class="text-[10px] font-mono text-sky-400 font-bold tracking-[0.3em] group-hover:text-white transition-colors">ACCESS RAW DATA ‚Üó</span>
                                <span class="text-[9px] text-slate-600 truncate max-w-[200px]">${d.link}</span>
                            </a>
                        </div>
                    </div>
                </div>`;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        async function exportBriefing() {
            const data = await d3.json("./latest_news.json?v=" + Date.now());
            let report = `ORBITAL INTELLIGENCE - STRATEGIC BRIEFING\nDATE: ${new Date().toISOString()}\n\n`;
            data.categorias.forEach(cat => {
                const div = cat.particulas.filter(p => p.proximidad < 60);
                if(div.length > 0) {
                    report += `[ ${cat.nombre.toUpperCase()} ]\n`;
                    div.forEach(p => report += `- ${p.bloque} (${p.proximidad}%): ${p.titulo}\n`);
                    report += `\n`;
                }
            });
            const blob = new Blob([report], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Briefing_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
        }

        function closePanel() { document.getElementById('side-panel').classList.add('translate-x-full'); }
        init();
        window.addEventListener('resize', () => location.reload());
    </script>
</body>
</html>
