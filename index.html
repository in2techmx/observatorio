<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Intelligence | Cyber Radar</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #010409; --neon-blue: #00d4ff; --neon-pink: #ff0055; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        #universe { background-image: radial-gradient(circle at 2px 2px, rgba(0, 212, 255, 0.05) 1px, transparent 0); background-size: 40px 40px; }

        /* Estilo de los Anillos (Círculos de %) */
        .radar-line { fill: none; stroke: rgba(255, 255, 255, 0.15); stroke-width: 0.8; stroke-dasharray: 3, 6; }
        .radar-grid { fill: none; stroke: rgba(255, 255, 255, 0.03); stroke-width: 0.5; }
        .label-pct { font-family: 'JetBrains Mono'; font-size: 7px; fill: #475569; letter-spacing: 1px; }

        /* Botón Cyberpunk */
        .cyber-button {
            background: linear-gradient(45deg, #00d4ff 5%, #0055ff 100%);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0% 30%);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
            transition: 0.3s;
        }
        .cyber-button:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(0, 212, 255, 0.6); }

        /* Partículas */
        .particle { cursor: pointer; transition: 0.4s; }
        .particle:hover { filter: brightness(1.5) drop-shadow(0 0 10px currentColor); }

        /* Modal Guía */
        #guide-modal { 
            background: rgba(1, 4, 9, 0.95); backdrop-filter: blur(25px); 
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: 0.5s;
        }
    </style>
</head>
<body>

    <div id="universe" class="w-screen h-screen relative">
        <header class="absolute top-8 left-8 z-30 flex flex-col gap-4">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter text-white">TACTICAL <span class="text-sky-400">RADAR</span></h1>
                <span id="news-count" class="text-[9px] font-mono text-slate-500 uppercase tracking-[0.3em]">Sincronizando satélites...</span>
            </div>
            <button onclick="exportBriefing()" class="w-fit text-[8px] font-mono text-slate-400 border border-white/10 px-3 py-1 hover:bg-white/5 uppercase">
                Export Briefing
            </button>
        </header>

        <button onclick="toggleGuide()" class="fixed bottom-8 right-8 z-50 cyber-button px-6 py-3 text-black font-black text-[10px] tracking-[0.2em] uppercase">
            [ Reference Guide ]
        </button>

        <div id="guide-modal" class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none p-10">
            <div class="max-w-xl w-full p-8 border-l-4 border-sky-500 bg-white/5">
                <div class="flex justify-between items-start mb-10">
                    <h4 class="text-sky-400 font-black tracking-widest uppercase text-xs">Decodificación de Radar</h4>
                    <button onclick="toggleGuide()" class="text-slate-500 hover:text-white">[X]</button>
                </div>
                <div class="grid grid-cols-2 gap-10">
                    <div>
                        <span class="text-[8px] text-slate-500 uppercase mb-4 block">Bloques Geopolíticos</span>
                        <div id="legend-items" class="space-y-2"></div>
                    </div>
                    <div>
                        <span class="text-[8px] text-slate-500 uppercase mb-4 block">Ejes de Convergencia</span>
                        <ul class="text-[10px] space-y-3 font-mono">
                            <li><span class="text-sky-400">CENTER (100%):</span> Consenso Global Absoluto.</li>
                            <li><span class="text-slate-300">INNER (75%):</span> Alineación estratégica.</li>
                            <li><span class="text-slate-500">OUTER (25%):</span> Sesgo regional crítico.</li>
                            <li><span class="text-rose-500">EDGE (0%):</span> Ruptura / Conflicto Narrativo.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[500px] z-[70] translate-x-full bg-slate-950/95 backdrop-blur-3xl border-l border-white/10 p-12 overflow-y-auto">
        <button onclick="closePanel()" class="mb-16 text-slate-500 hover:text-white text-[10px] font-black uppercase tracking-widest">← Return to Radar</button>
        <div id="panel-content"></div>
    </aside>

    <script>
        const width = window.innerWidth, height = window.innerHeight;
        const svg = d3.select("#universe").append("svg").attr("width", width).attr("height", height);
        const BLOQUE_COLORS = {"USA": "#3b82f6", "Europa": "#fde047", "Rusia": "#ef4444", "China": "#f97316", "LATAM": "#d946ef", "Medio Oriente": "#10b981", "África": "#8b5cf6"};

        async function init() {
            try {
                const data = await d3.json("./latest_news.json?v=" + Date.now());
                const legend = document.getElementById('legend-items');
                Object.entries(BLOQUE_COLORS).forEach(([name, color]) => {
                    legend.innerHTML += `<div class="flex items-center gap-2"><div class="w-1.5 h-1.5" style="background:${color}"></div><span class="text-[9px] font-mono uppercase">${name}</span></div>`;
                });

                const centers = {
                    "Seguridad y Conflictos": {x: width * 0.25, y: height * 0.35, color: "#f43f5e"},
                    "Economía y Sanciones":   {x: width * 0.50, y: height * 0.55, color: "#fbbf24"},
                    "Energía y Recursos":    {x: width * 0.75, y: height * 0.35, color: "#22c55e"},
                    "Soberanía y Alianzas":  {x: width * 0.35, y: height * 0.78, color: "#a855f7"},
                    "Tecnología y Espacio":  {x: width * 0.65, y: height * 0.78, color: "#0ea5e9"}
                };

                const MAX_R = 150;
                let total = 0;

                Object.keys(centers).forEach(cat => {
                    const c = centers[cat];
                    const catData = data.categorias.find(x => x.nombre === cat);
                    const g = svg.append("g");

                    // DIBUJO DE ANILLOS (LOS CÍRCULOS DE %)
                    [0.25, 0.5, 0.75, 1].forEach(r => {
                        g.append("circle").attr("cx", c.x).attr("cy", c.y).attr("r", MAX_R * r).attr("class", "radar-line");
                        g.append("text").attr("x", c.x + (MAX_R * r) + 5).attr("y", c.y).attr("class", "label-pct").text(`${Math.round((1-r)*100)}%`);
                    });

                    // NÚCLEO
                    g.append("circle").attr("cx", c.x).attr("cy", c.y).attr("r", 5).attr("fill", c.color).style("filter", "blur(5px)");
                    g.append("text").attr("x", c.x).attr("y", c.y + MAX_R + 30).attr("text-anchor", "middle").attr("class", "label-pct").style("fill", "#94a3b8").text(cat.toUpperCase());

                    if(catData && catData.particulas) {
                        total += catData.particulas.length;
                        catData.particulas.forEach((p, i) => {
                            const angle = (i / catData.particulas.length) * (Math.PI * 2);
                            const rPos = MAX_R - (p.proximidad * (MAX_R / 100)) + 15;
                            const px = c.x + rPos * Math.cos(angle);
                            const py = c.y + rPos * Math.sin(angle);

                            const pg = g.append("g").attr("class", "particle").attr("transform", `translate(${px},${py})`).on("click", () => openPanel({...p, catColor: c.color}));
                            pg.append("circle").attr("r", 5).attr("fill", p.color_bloque).style("filter", `drop-shadow(0 0 5px ${p.color_bloque})`);
                            pg.append("circle").attr("r", 1).attr("fill", "#fff");
                        });
                    }
                });
                document.getElementById('news-count').innerText = `${total} NODOS EN RED`;
            } catch (e) { console.error(e); }
        }

        function toggleGuide() {
            const m = document.getElementById('guide-modal');
            const isActive = m.style.opacity === "1";
            m.style.opacity = isActive ? "0" : "1";
            m.style.pointerEvents = isActive ? "none" : "auto";
        }

        function openPanel(d) {
            document.getElementById('panel-content').innerHTML = `
                <div style="background:${d.color_bloque}" class="px-3 py-1 text-[10px] font-black text-black inline-block mb-10">${d.bloque}</div>
                <h2 class="text-4xl font-black text-white mb-6 uppercase leading-none">${d.titulo}</h2>
                <p class="text-xl text-slate-300 font-light mb-10">${d.analisis_regional}</p>
                <div class="p-6 bg-white/5 border-l-2 mb-10" style="border-color:${d.catColor}">
                    <p class="text-xs text-slate-500 italic">"${d.consenso || 'Consenso global activo'}"</p>
                </div>
                <a href="${d.link}" target="_blank" class="text-sky-400 font-black text-xs hover:underline tracking-widest">ACCESS DATA_STREAM ↗</a>`;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        function closePanel() { document.getElementById('side-panel').classList.add('translate-x-full'); }
        init();
    </script>
</body>
</html>
