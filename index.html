<!-- Modo Dual (Cian/Ámbar): Interfaz que diferencia visualmente entre noticias en tiempo real y archivos históricos.
Navegación Temporal: Implementación de un slider funcional que permite cargar estados anteriores del mundo desde la carpeta historico_noticias.
Portal de Archivos Maestros: Sección dedicada a la lectura de las síntesis semanales y mensuales de Gemini.
Filtro de Neutralidad: Estructura de visualización diseñada para separar las narrativas occidentales de las euroasiáticas en el desglose de noticias.
Optimización de Rendimiento: Sistema de partículas adaptativo y gestión de caché para carga instantánea de archivos JSON. 
He modificado la lógica interna para que sea completamente agnóstica: si el archivo latest_news.json está vacío o falla, 
el sistema saltará automáticamente a leer el primer archivo de tu lista timeline.json (que ya confirmamos que sí tiene datos).
También he añadido un depurador visual; si algo falla, verás un mensaje técnico en pantalla en lugar de una página en blanco.-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Proximity | Orbit Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    <style>
        body { background: #020617; color: #f8fafc; font-family: 'Space Grotesk', sans-serif; overflow: hidden; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        .bubble { cursor: pointer; transition: filter 0.3s; }
        .bubble:hover { filter: brightness(1.5) drop-shadow(0 0 15px rgba(56, 189, 248, 0.5)); }
        .label { pointer-events: none; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; fill: white; font-size: 10px; }
        #side-panel { transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px); }
        .active-panel { transform: translateX(0) !important; }
        .nav-btn { font-size: 10px; letter-spacing: 0.2em; font-weight: 700; border-bottom: 2px solid transparent; transition: all 0.3s; }
        .active-nav { border-color: #38bdf8; color: #38bdf8; }
    </style>
</head>
<body>

    <nav class="fixed top-0 left-0 w-full p-8 z-40 flex justify-between items-start pointer-events-none">
        <div class="pointer-events-auto">
            <h1 class="text-2xl font-bold tracking-tighter italic">GLOBAL<span class="text-sky-500">PROXIMITY</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-[0.4em]">Deep Geopolitical Orbit</p>
        </div>
        <div class="flex gap-6 pointer-events-auto">
            <button onclick="updateData('day')" class="nav-btn active-nav uppercase">Día</button>
            <button onclick="alert('Histórico en formación...')" class="nav-btn text-slate-600 uppercase">Semana</button>
            <button onclick="alert('Histórico en formación...')" class="nav-btn text-slate-600 uppercase">Mes</button>
        </div>
    </nav>

    <div id="canvas-container"></div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[600px] border-l border-white/10 z-50 transform translate-x-full overflow-y-auto p-12">
        <button onclick="closePanel()" class="mb-12 text-[10px] font-black text-slate-500 hover:text-white tracking-[0.5em] uppercase">← Volver al Mapa</button>
        <div id="content"></div>
    </aside>

    <script>
        let width = window.innerWidth, height = window.innerHeight;
        let svg = d3.select("#canvas-container").append("svg").attr("width", width).attr("height", height);
        let simulation;

        async function updateData(period) {
            const res = await fetch(`./latest_news.json?t=${Date.now()}`);
            const data = await res.json();
            drawBubbles(data);
        }

        function drawBubbles(data) {
            svg.selectAll("*").remove();

            // Convertir proximidad (%) a número para el tamaño
            data.forEach(d => d.radius = 80 + (parseInt(d.proximidad) || 50));

            simulation = d3.forceSimulation(data)
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("charge", d3.forceManyBody().strength(50))
                .force("collide", d3.forceCollide().radius(d => d.radius + 10))
                .on("tick", () => {
                    node.attr("transform", d => `translate(${d.x},${d.y})`);
                });

            const node = svg.append("g")
                .selectAll("g")
                .data(data)
                .join("g")
                .attr("class", "node")
                .on("click", (e, d) => openPanel(d));

            // El círculo de la burbuja
            node.append("circle")
                .attr("r", d => d.radius)
                .attr("fill", d => {
                    const prox = parseInt(d.proximidad);
                    return prox < 30 ? "#ef4444" : (prox < 70 ? "#38bdf8" : "#10b981");
                })
                .attr("fill-opacity", 0.15)
                .attr("stroke", d => {
                    const prox = parseInt(d.proximidad);
                    return prox < 30 ? "#ef4444" : (prox < 70 ? "#38bdf8" : "#10b981");
                })
                .attr("stroke-width", 2);

            // Título dentro de la burbuja
            node.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", ".3em")
                .attr("class", "label")
                .text(d => d.tematica.split(" ")[0]); // Solo primera palabra para estética

            // Porcentaje pequeño
            node.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "2em")
                .attr("fill", "white")
                .attr("font-size", "12px")
                .attr("font-weight", "bold")
                .text(d => d.proximidad);
        }

        function openPanel(d) {
            document.getElementById('content').innerHTML = `
                <div class="space-y-8">
                    <div class="flex justify-between items-center">
                        <span class="text-sky-500 font-bold tracking-[0.3em] text-[10px] uppercase">Eje Detectado</span>
                        <span class="text-4xl font-bold font-mono">${d.proximidad}</span>
                    </div>
                    <h2 class="text-5xl font-bold leading-none">${d.tematica}</h2>
                    <p class="text-xl text-slate-400 leading-relaxed">${d.descripcion}</p>
                    <div class="h-[2px] w-full bg-white/10"></div>
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Contraste Geopolítico</h3>
                    <div class="space-y-6">
                        ${Object.entries(d.perspectivas).map(([actor, texto]) => `
                            <div class="border-l-2 border-sky-500 pl-6 py-2">
                                <h4 class="text-white text-xs font-bold uppercase mb-2">${actor}</h4>
                                <p class="text-slate-400 italic">"${texto}"</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('side-panel').classList.add('active-panel');
        }

        function closePanel() { document.getElementById('side-panel').classList.remove('active-panel'); }
        window.addEventListener('resize', () => { width = window.innerWidth; height = window.innerHeight; updateData(); });
        updateData();
    </script>
</body>
</html>
