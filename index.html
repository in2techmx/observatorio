<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Intelligence | Tactical Command</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #010409; --cyber-blue: #00d4ff; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        
        #universe { 
            background-image: radial-gradient(circle at 2px 2px, rgba(0, 212, 255, 0.03) 1px, transparent 0); 
            background-size: 50px 50px; 
        }

        /* ANILLOS DE RADAR REFORZADOS */
        .radar-line { 
            fill: none; 
            stroke: rgba(255, 255, 255, 0.5); /* Alta visibilidad */
            stroke-width: 1.5; 
            filter: drop-shadow(0 0 3px rgba(0, 212, 255, 0.3));
        }
        
        .radar-grid-line {
            fill: none;
            stroke: rgba(255, 255, 255, 0.05);
            stroke-width: 0.5;
        }

        .label-pct { 
            font-family: 'JetBrains Mono'; 
            font-size: 9px; 
            fill: #00d4ff; 
            font-weight: 700;
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
        }

        .label-cat { 
            font-family: 'JetBrains Mono'; 
            font-size: 11px; 
            fill: #94a3b8; 
            font-weight: 800; 
            letter-spacing: 0.4em;
        }

        /* BOTÓN CYBERPUNK */
        .cyber-button {
            background: #00d4ff;
            clip-path: polygon(0% 15%, 15% 0%, 100% 0%, 100% 85%, 85% 100%, 0% 100%);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
            transition: 0.3s;
            color: black;
        }
        .cyber-button:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 0 35px rgba(0, 212, 255, 0.7); 
        }

        /* PARTÍCULAS */
        .particle { cursor: pointer; transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .particle:hover { filter: brightness(1.8) drop-shadow(0 0 15px currentColor); }

        /* MODAL Y PANEL */
        .glass-panel { background: rgba(1, 4, 9, 0.96); backdrop-filter: blur(30px); border: 1px solid rgba(0, 212, 255, 0.2); }
        #side-panel { transition: 0.7s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body>

    <div id="universe" class="w-screen h-screen relative">
        <header class="absolute top-8 left-8 z-30 flex flex-col gap-4">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter text-white">ORBITAL <span class="text-sky-400">COMMAND</span></h1>
                <div id="news-count" class="text-[9px] font-mono text-sky-500/70 uppercase tracking-widest mt-1 font-bold">Iniciando escaneo...</div>
            </div>
            <button onclick="exportBriefing()" class="w-fit text-[8px] font-mono text-slate-500 border border-white/10 px-4 py-1.5 hover:bg-sky-500/10 hover:text-sky-400 transition-all uppercase tracking-widest">
                Download Briefing
            </button>
        </header>

        <button onclick="toggleGuide()" class="fixed bottom-8 right-8 z-50 cyber-button px-8 py-3 font-black text-[10px] tracking-[0.2em] uppercase">
            [ Guía de Inteligencia ]
        </button>

        <div id="guide-modal" class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500 bg-black/80">
            <div class="glass-panel max-w-2xl w-full p-10 border-l-[6px] border-sky-500">
                <div class="flex justify-between items-start mb-10 border-b border-white/10 pb-4">
                    <h4 class="text-sky-400 font-black tracking-widest uppercase text-xs">Anatomía del Radar</h4>
                    <button onclick="toggleGuide()" class="text-slate-500 hover:text-white font-mono">[ ESC ]</button>
                </div>
                <div class="grid grid-cols-2 gap-12 text-slate-300">
                    <div>
                        <span class="text-[9px] text-sky-500/50 font-bold uppercase mb-4 block">Bloques Geopolíticos</span>
                        <div id="legend-items" class="grid grid-cols-1 gap-3"></div>
                    </div>
                    <div>
                        <span class="text-[9px] text-sky-500/50 font-bold uppercase mb-4 block">Capas de Convergencia</span>
                        <ul class="text-[10px] space-y-4 font-mono">
                            <li><strong class="text-sky-400">CENTRO (100%):</strong> Alineación Total / Consenso.</li>
                            <li><strong class="text-slate-200">INTERMEDIO (75-50%):</strong> Matices regionales.</li>
                            <li><strong class="text-rose-500">EXTERIOR (25-0%):</strong> Divergencia / Ruptura narrativa.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[550px] z-[70] translate-x-full glass-panel p-12 overflow-y-auto">
        <button onclick="closePanel()" class="mb-16 text-slate-500 hover:text-sky-400 text-[10px] font-black uppercase tracking-[0.4em] transition-colors italic">← Regresar al Radar</button>
        <div id="panel-content"></div>
    </aside>

    <script>
        const width = window.innerWidth, height = window.innerHeight;
        const svg = d3.select("#universe").append("svg").attr("width", width).attr("height", height);
        const BLOQUE_COLORS = {"USA": "#3b82f6", "Europa": "#fde047", "Rusia": "#ef4444", "China": "#f97316", "LATAM": "#d946ef", "Medio Oriente": "#10b981", "África": "#8b5cf6"};

        async function init() {
            try {
                const data = await d3.json("./latest_news.json?v=" + Date.now());
                const legend = document.getElementById('legend-items');
                Object.entries(BLOQUE_COLORS).forEach(([name, color]) => {
                    legend.innerHTML += `<div class="flex items-center gap-3"><div class="w-3 h-3 rounded-sm" style="background:${color}; box-shadow: 0 0 10px ${color}66"></div><span class="text-[10px] font-mono uppercase tracking-widest font-bold text-slate-200">${name}</span></div>`;
                });

                const centers = {
                    "Seguridad y Conflictos": {x: width * 0.25, y: height * 0.35, color: "#f43f5e"},
                    "Economía y Sanciones":   {x: width * 0.50, y: height * 0.55, color: "#fbbf24"},
                    "Energía y Recursos":    {x: width * 0.75, y: height * 0.35, color: "#22c55e"},
                    "Soberanía y Alianzas":  {x: width * 0.35, y: height * 0.78, color: "#a855f7"},
                    "Tecnología y Espacio":  {x: width * 0.65, y: height * 0.78, color: "#0ea5e9"}
                };

                const MAX_R = 150;
                let total = 0;

                Object.keys(centers).forEach(cat => {
                    const c = centers[cat];
                    const catData = data.categorias.find(x => x.nombre === cat);
                    const rg = svg.append("g");

                    // 1. DIBUJO DE REJILLA RADIAL (LÍNEAS CRUZADAS)
                    [0, 90].forEach(angle => {
                        rg.append("line")
                            .attr("x1", c.x - MAX_R).attr("y1", c.y)
                            .attr("x2", c.x + MAX_R).attr("y2", c.y)
                            .attr("class", "radar-grid-line")
                            .attr("transform", `rotate(${angle}, ${c.x}, ${c.y})`);
                    });

                    // 2. DIBUJO DE ANILLOS (CÍRCULOS DE % MARCADOS)
                    [0.25, 0.5, 0.75, 1].forEach(r => {
                        rg.append("circle")
                            .attr("cx", c.x).attr("cy", c.y)
                            .attr("r", MAX_R * r)
                            .attr("class", "radar-line");
                        
                        // Etiqueta de porcentaje clara
                        rg.append("text")
                            .attr("x", c.x + 5)
                            .attr("y", c.y - (MAX_R * r) + 12)
                            .attr("class", "label-pct")
                            .text(`${Math.round((1-r)*100)}%`);
                    });

                    // 3. NÚCLEO Y ETIQUETA
                    rg.append("circle").attr("cx", c.x).attr("cy", c.y).attr("r", 5).attr("fill", c.color).style("filter", "blur(8px)");
                    rg.append("text").attr("x", c.x).attr("y", c.y + MAX_R + 40).attr("text-anchor", "middle").attr("class", "label-cat").text(cat.toUpperCase());

                    if(catData && catData.particulas) {
                        total += catData.particulas.length;
                        catData.particulas.forEach((p, i) => {
                            const angle = (i / catData.particulas.length) * (Math.PI * 2) - Math.PI/2;
                            const rPos = MAX_R - (p.proximidad * (MAX_R / 100)) + 15;
                            const px = c.x + rPos * Math.cos(angle);
                            const py = c.y + rPos * Math.sin(angle);

                            const pg = rg.append("g").attr("class", "particle").attr("transform", `translate(${px},${py})`).on("click", () => openPanel({...p, catColor: c.color, catConsensus: catData.consenso}));
                            
                            pg.append("circle")
                                .attr("r", 6 + (p.proximidad / 15))
                                .attr("fill", p.color_bloque)
                                .style("filter", `drop-shadow(0 0 10px ${p.color_bloque})`);
                            
                            pg.append("circle").attr("r", 1.5).attr("fill", "#fff").style("opacity", 0.8);
                        });
                    }
                });
                document.getElementById('news-count').innerText = `${total} NODOS EN ESCANEO TÁCTICO`;
            } catch (e) { console.error(e); }
        }

        function toggleGuide() {
            const m = document.getElementById('guide-modal');
            const active = m.style.opacity === "1";
            m.style.opacity = active ? "0" : "1";
            m.style.pointerEvents = active ? "none" : "auto";
        }

        function openPanel(d) {
            document.getElementById('panel-content').innerHTML = `
                <div class="flex justify-between items-start mb-12 animate-in fade-in slide-in-from-right duration-500">
                    <div style="background:${d.color_bloque}" class="px-4 py-1 text-[11px] font-black text-black uppercase tracking-widest">${d.bloque}</div>
                    <div class="text-right">
                        <div class="text-[9px] font-mono text-slate-500 uppercase tracking-widest">Alineación</div>
                        <div class="text-4xl font-black text-white">${d.proximidad}%</div>
                    </div>
                </div>
                <h2 class="text-3xl font-black text-white mb-8 leading-tight italic uppercase tracking-tighter">${d.titulo}</h2>
                <div class="space-y-10">
                    <div>
                        <h4 class="text-[10px] font-bold text-sky-400 uppercase tracking-[0.4em] mb-4">Análisis de Inteligencia</h4>
                        <p class="text-xl text-slate-200 font-light leading-relaxed">${d.analisis_regional}</p>
                    </div>
                    <div class="p-6 bg-white/5 border-l-4" style="border-color:${d.catColor}">
                        <h4 class="text-[9px] font-bold text-slate-500 uppercase mb-2">Consenso Detectado</h4>
                        <p class="text-sm text-slate-400 italic font-serif leading-relaxed">"${d.catConsensus}"</p>
                    </div>
                    <div class="pt-10 border-t border-white/5">
                        <a href="${d.link}" target="_blank" class="flex justify-between items-center group bg-sky-500/5 p-4 rounded border border-sky-500/10 hover:bg-sky-500/10 transition-all">
                            <span class="text-[10px] font-black text-sky-400 tracking-widest uppercase">Acceder a Fuente Original ↗</span>
                        </a>
                    </div>
                </div>`;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        async function exportBriefing() {
            const data = await d3.json("./latest_news.json?v=" + Date.now());
            let report = `BRIEFING TÁCTICO - ${new Date().toLocaleDateString()}\n====================================\n\n`;
            data.categorias.forEach(cat => {
                const p = cat.particulas.filter(x => x.proximidad < 60);
                if(p.length > 0) {
                    report += `[ CATEGORÍA: ${cat.nombre.toUpperCase()} ]\n`;
                    p.forEach(n => report += `- ${n.bloque} (${n.proximidad}%): ${n.titulo}\n`);
                    report += `\n`;
                }
            });
            const blob = new Blob([report], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Briefing_Orbital_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
        }

        function closePanel() { document.getElementById('side-panel').classList.add('translate-x-full'); }
        init();
        window.addEventListener('resize', () => location.reload());
    </script>
</body>
</html>
