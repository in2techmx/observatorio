<script>
    let fullData = null;
    let scatterChart = null;
    // Mapeo exacto de bloques para asegurar colores
    const BLOQUE_COLORS = { 
        "USA": "#3b82f6", "EUROPE": "#fde047", "RUSSIA": "#ef4444", 
        "CHINA": "#f97316", "LATAM": "#d946ef", "MID_EAST": "#10b981", 
        "INDIA": "#8b5cf6", "AFRICA": "#22c55e" 
    };

    async function init() {
        try {
            const res = await fetch(`./gravity_carousel.json?t=${Date.now()}`);
            fullData = await res.json();
            document.getElementById('update-tag').innerText = "HUB ONLINE // " + new Date().toLocaleTimeString();
            renderCarousel();
        } catch (e) {
            console.error("Error cargando datos:", e);
        }
    }

    function renderCarousel() {
        const container = document.getElementById('area-carousel');
        if (!fullData.carousel) return;
        container.innerHTML = fullData.carousel.map((area, idx) => `
            <div class="area-card glass rounded-[2rem] p-8 border-t-4" 
                 style="border-top-color: ${area.color}" 
                 onclick="openAreaModal(${idx})">
                <h3 class="text-2xl font-black text-white mb-4 uppercase italic tracking-tighter">${area.area}</h3>
                <p class="text-slate-500 text-xs leading-relaxed line-clamp-3 mb-6">${area.punto_cero}</p>
                <div class="flex justify-between items-center text-[10px] font-mono text-blue-500">
                    <span>${area.particulas ? area.particulas.length : 0} SEÑALES</span>
                    <span class="font-black">ESCANEAR RADAR →</span>
                </div>
            </div>
        `).join('');
    }

    function openAreaModal(idx) {
        const area = fullData.carousel[idx];
        document.getElementById('modal-area-title').innerText = area.area;
        document.getElementById('modal-punto-cero').innerText = area.punto_cero;
        document.getElementById('area-modal').classList.add('open');
        
        // FORZAR RENDERIZADO: Esperamos a que la animación del modal termine
        setTimeout(() => {
            renderRadar(area.particulas || []);
        }, 400); 
    }

    function renderRadar(particulas) {
        const canvas = document.getElementById('areaScatterChart');
        const ctx = canvas.getContext('2d');
        
        if (scatterChart) scatterChart.destroy();

        // Creamos los datasets asegurando que cada partícula sea visible
        const datasets = particulas.map((p, i) => {
            // Conversión de proximidad a coordenadas polares para el radar
            // proximidad 100 = centro (radio 0), proximidad 0 = periferia (radio 100)
            const radius = 100 - p.proximidad;
            const angle = (i / particulas.length) * 2 * Math.PI;
            
            return {
                label: p.titulo,
                data: [{
                    x: radius * Math.cos(angle),
                    y: radius * Math.sin(angle)
                }],
                backgroundColor: BLOQUE_COLORS[p.bloque] || '#ffffff',
                borderColor: '#ffffff',
                borderWidth: 1,
                pointRadius: 8,
                pointHoverRadius: 12,
                original: p
            };
        });

        scatterChart = new Chart(ctx, {
            type: 'scatter',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 1000, easing: 'easeOutQuart' },
                onClick: (e, el) => {
                    if (el.length) {
                        const data = scatterChart.data.datasets[el[0].datasetIndex].original;
                        openNewsDetail(data);
                    }
                },
                scales: {
                    x: { display: false, min: -120, max: 120 },
                    y: { display: false, min: -120, max: 120 }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'radarBackground',
                beforeDraw: (chart) => {
                    const {ctx, chartArea: {left, top, right, bottom}} = chart;
                    const cx = (left + right) / 2;
                    const cy = (top + bottom) / 2;
                    
                    ctx.save();
                    // Dibujar líneas de órbita más visibles
                    [25, 50, 75, 100].forEach(r => {
                        ctx.beginPath();
                        ctx.arc(cx, cy, r * (chart.scales.x.width / 240), 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)'; // Más brillante
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        
                        // Etiquetas de órbita
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.font = '10px monospace';
                        ctx.fillText(`${100-r}%`, cx + 5, cy - (r * (chart.scales.x.width / 240)) - 2);
                    });

                    // Punto Cero Central
                    ctx.beginPath();
                    ctx.arc(cx, cy, 12, 0, Math.PI * 2);
                    ctx.fillStyle = '#3b82f6';
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#3b82f6';
                    ctx.fill();
                    ctx.restore();
                }
            }]
        });
    }

    function openNewsDetail(p) {
        document.getElementById('detail-title').innerText = p.titulo;
        document.getElementById('detail-proximidad').innerText = p.proximidad + "%";
        document.getElementById('detail-sesgo').innerText = p.sesgo;
        document.getElementById('detail-link').href = p.link;
        const tag = document.getElementById('detail-tag');
        tag.innerText = p.bloque;
        tag.style.color = BLOQUE_COLORS[p.bloque];
        tag.style.borderColor = BLOQUE_COLORS[p.bloque];
        document.getElementById('news-detail-modal').classList.add('open');
    }

    function closeAreaModal() { document.getElementById('area-modal').classList.remove('open'); }
    function closeNewsDetailModal() { document.getElementById('news-detail-modal').classList.remove('open'); }

    init();
</script>
