<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactical Intelligence Radar</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #010409; --neon: #00f2ff; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        
        /* REJILLA DE FONDO DE LA PANTALLA */
        #universe { 
            background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px), 
                              linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 60px 60px;
        }

        /* ANILLOS DE RADAR: MÁXIMA VISIBILIDAD */
        .radar-line { 
            fill: none; 
            stroke: #ffffff; /* Blanco sólido */
            stroke-width: 2.5px; /* Línea gruesa */
            stroke-opacity: 0.8; /* Casi opaca */
            filter: drop-shadow(0 0 5px rgba(0, 242, 255, 0.8)); /* Brillo neón fuerte */
        }
        
        .radar-grid-axis {
            stroke: rgba(0, 242, 255, 0.3);
            stroke-width: 1px;
            stroke-dasharray: 4;
        }

        .label-pct { 
            font-family: 'JetBrains Mono'; 
            font-size: 11px; 
            fill: #00f2ff; 
            font-weight: 900;
            text-shadow: 0 0 10px #00f2ff;
        }

        .label-cat { 
            font-family: 'JetBrains Mono'; 
            font-size: 13px; 
            fill: #ffffff; 
            font-weight: 900; 
            letter-spacing: 0.5em;
            text-transform: uppercase;
        }

        /* BOTÓN CYBERPUNK */
        .cyber-button {
            background: #00f2ff;
            clip-path: polygon(0% 20%, 20% 0%, 100% 0%, 100% 80%, 80% 100%, 0% 100%);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.5);
            transition: 0.2s;
            color: black;
            font-weight: 900;
        }

        /* PARTÍCULAS */
        .particle { cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .particle:hover { filter: brightness(2) scale(1.3); }

        .glass-panel { background: rgba(1, 4, 9, 0.98); backdrop-filter: blur(40px); border-left: 2px solid #00f2ff; }
    </style>
</head>
<body>

    <div id="universe" class="w-screen h-screen relative">
        <header class="absolute top-8 left-8 z-30">
            <h1 class="text-2xl font-black italic tracking-tighter text-white border-l-4 border-cyan-500 pl-4">STRATEGIC RADAR <span class="text-cyan-400">V.3.0</span></h1>
            <button onclick="exportBriefing()" class="mt-4 px-4 py-1 bg-cyan-950 text-cyan-400 border border-cyan-500/50 text-[10px] font-bold uppercase tracking-widest hover:bg-cyan-500 hover:text-black transition-all">
                Export Intel Report
            </button>
        </header>

        <button onclick="toggleGuide()" class="fixed bottom-8 right-8 z-50 cyber-button px-10 py-4 text-[11px] tracking-widest uppercase">
            [ Ver Guía Técnica ]
        </button>

        <div id="guide-modal" class="fixed inset-0 z-[60] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300 bg-black/90">
            <div class="glass-panel max-w-2xl w-full p-12 shadow-[0_0_100px_rgba(0,242,255,0.2)]">
                <div class="flex justify-between items-center mb-10 border-b-2 border-cyan-500 pb-4">
                    <h4 class="text-cyan-400 font-black tracking-widest uppercase">Manual de Referencia del Radar</h4>
                    <button onclick="toggleGuide()" class="text-white hover:text-cyan-400 font-black">[ ESC ]</button>
                </div>
                <div class="grid grid-cols-2 gap-10">
                    <div>
                        <span class="text-[10px] text-cyan-500 font-bold uppercase mb-4 block">Identificación de Bloques</span>
                        <div id="legend-items" class="space-y-3"></div>
                    </div>
                    <div>
                        <span class="text-[10px] text-cyan-500 font-bold uppercase mb-4 block">Escala de Proximidad</span>
                        <ul class="text-[11px] space-y-4 font-mono text-white">
                            <li><strong class="text-cyan-400">100% (CENTRO):</strong> Convergencia Global.</li>
                            <li><strong class="text-white">75% - 50%:</strong> Perspectiva Regional.</li>
                            <li><strong class="text-red-500">25% - 0% (BORDE):</strong> Divergencia / Tensión.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[550px] z-[70] translate-x-full glass-panel p-12 overflow-y-auto shadow-[-50px_0_100px_rgba(0,0,0,0.9)]">
        <button onclick="closePanel()" class="mb-16 text-cyan-500 hover:text-white text-[11px] font-black uppercase tracking-[0.5em]">← Back to Sensor</button>
        <div id="panel-content"></div>
    </aside>

    <script>
        const width = window.innerWidth, height = window.innerHeight;
        const svg = d3.select("#universe").append("svg").attr("width", width).attr("height", height);
        const BLOQUE_COLORS = {"USA": "#3b82f6", "Europa": "#fde047", "Rusia": "#ef4444", "China": "#f97316", "LATAM": "#d946ef", "Medio Oriente": "#10b981", "África": "#8b5cf6"};

        async function init() {
            try {
                const data = await d3.json("./latest_news.json?v=" + Date.now());
                const legend = document.getElementById('legend-items');
                Object.entries(BLOQUE_COLORS).forEach(([name, color]) => {
                    legend.innerHTML += `<div class="flex items-center gap-3"><div class="w-4 h-4" style="background:${color}; border: 1px solid white"></div><span class="text-[11px] font-bold uppercase text-white">${name}</span></div>`;
                });

                const centers = {
                    "Seguridad y Conflictos": {x: width * 0.25, y: height * 0.35, color: "#f43f5e"},
                    "Economía y Sanciones":   {x: width * 0.50, y: height * 0.55, color: "#fbbf24"},
                    "Energía y Recursos":    {x: width * 0.75, y: height * 0.35, color: "#22c55e"},
                    "Soberanía y Alianzas":  {x: width * 0.35, y: height * 0.78, color: "#a855f7"},
                    "Tecnología y Espacio":  {x: width * 0.65, y: height * 0.78, color: "#0ea5e9"}
                };

                const MAX_R = 150;

                Object.keys(centers).forEach(cat => {
                    const c = centers[cat];
                    const catData = data.categorias.find(x => x.nombre === cat);
                    const rg = svg.append("g");

                    // 1. REJILLA DE EJES
                    [0, 90, 45, 135].forEach(a => {
                        rg.append("line").attr("x1", c.x - MAX_R).attr("y1", c.y).attr("x2", c.x + MAX_R).attr("y2", c.y)
                          .attr("class", "radar-grid-axis").attr("transform", `rotate(${a}, ${c.x}, ${c.y})`);
                    });

                    // 2. ANILLOS SÓLIDOS (MÁXIMO CONTRASTE)
                    [0.25, 0.5, 0.75, 1].forEach(r => {
                        rg.append("circle").attr("cx", c.x).attr("cy", c.y).attr("r", MAX_R * r).attr("class", "radar-line");
                        
                        // Etiqueta de % muy clara
                        rg.append("text").attr("x", c.x + 5).attr("y", c.y - (MAX_R * r) + 15).attr("class", "label-pct")
                          .text(`${Math.round((1-r)*100)}%`);
                    });

                    // 3. ETIQUETA DE CATEGORÍA
                    rg.append("text").attr("x", c.x).attr("y", c.y + MAX_R + 50).attr("text-anchor", "middle").attr("class", "label-cat").text(cat);

                    if(catData && catData.particulas) {
                        catData.particulas.forEach((p, i) => {
                            const angle = (i / catData.particulas.length) * (Math.PI * 2) - Math.PI/2;
                            const rPos = MAX_R - (p.proximidad * (MAX_R / 100)) + 15;
                            const px = c.x + rPos * Math.cos(angle);
                            const py = c.y + rPos * Math.sin(angle);

                            const pg = rg.append("g").attr("class", "particle").attr("transform", `translate(${px},${py})`).on("click", () => openPanel({...p, catColor: c.color, catConsensus: catData.consenso}));
                            pg.append("circle").attr("r", 8).attr("fill", p.color_bloque).style("stroke", "white").style("stroke-width", "2px");
                            pg.append("circle").attr("r", 2.5).attr("fill", "#000"); // Punto central negro para contraste
                        });
                    }
                });
            } catch (e) { console.error(e); }
        }

        function toggleGuide() {
            const m = document.getElementById('guide-modal');
            const active = m.style.opacity === "1";
            m.style.opacity = active ? "0" : "1";
            m.style.pointerEvents = active ? "none" : "auto";
        }

        function openPanel(d) {
            document.getElementById('panel-content').innerHTML = `
                <div class="bg-white text-black px-4 py-1 text-xs font-black uppercase mb-10 inline-block">${d.bloque} | ${d.proximidad}% CONVERGENCIA</div>
                <h2 class="text-4xl font-black text-white mb-8 leading-tight uppercase tracking-tighter">${d.titulo}</h2>
                <div class="space-y-10">
                    <p class="text-2xl text-slate-100 font-light leading-snug">${d.analisis_regional}</p>
                    <div class="p-8 border-l-8 bg-cyan-950/20 border-cyan-500">
                        <h4 class="text-xs font-black text-cyan-400 uppercase mb-2">Consenso Global Analizado</h4>
                        <p class="text-sm text-slate-400 italic font-serif">"${d.catConsensus}"</p>
                    </div>
                    <a href="${d.link}" target="_blank" class="block w-full text-center py-4 bg-cyan-500 text-black font-black uppercase text-xs tracking-widest hover:bg-white transition-all">Abrir Fuente Original ↗</a>
                </div>`;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        function closePanel() { document.getElementById('side-panel').classList.add('translate-x-full'); }
        async function exportBriefing() {
            const data = await d3.json("./latest_news.json?v=" + Date.now());
            let report = `REPORTE DE INTELIGENCIA ESTRATÉGICA\n\n`;
            data.categorias.forEach(cat => {
                const div = cat.particulas.filter(x => x.proximidad < 60);
                if(div.length > 0) {
                    report += `[ ${cat.nombre.toUpperCase()} ]\n`;
                    div.forEach(p => report += `- ${p.bloque}: ${p.titulo}\n`);
                    report += `\n`;
                }
            });
            const blob = new Blob([report], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Reporte_Divergencia.txt`;
            a.click();
        }
        init();
    </script>
</body>
</html>
