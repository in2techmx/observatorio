<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Proximity | Command Center</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; }
        body { background: var(--bg); color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        #universe { background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.03) 1px, transparent 0); background-size: 40px 40px; }
        .orbit-path { fill: none; stroke: rgba(255,255,255,0.07); stroke-width: 1; stroke-dasharray: 5,5; }
        .label-cat { font-family: 'JetBrains Mono', monospace; font-size: 10px; fill: #64748b; font-weight: bold; letter-spacing: 0.4em; pointer-events: none; }
        #side-panel { transition: 0.8s cubic-bezier(0.16, 1, 0.3, 1); background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(40px); border-left: 1px solid rgba(255,255,255,0.1); }
        .particle { cursor: pointer; transition: all 0.3s ease; }
        .particle:hover { filter: brightness(1.5) scale(1.1); }
        .sun-core { filter: blur(20px); opacity: 0.3; }
    </style>
</head>
<body>

    <div id="universe" class="w-screen h-screen relative">
        <header class="absolute top-10 left-10 z-10">
            <h1 class="text-xl font-black tracking-tighter italic text-white/90">ORBITAL INTELLIGENCE</h1>
            <div class="flex items-center gap-3 mt-1">
                <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 bg-sky-500 rounded-full animate-pulse"></div>
                    <span id="news-count" class="text-[9px] font-mono text-sky-400 font-bold uppercase tracking-widest">Cargando partículas...</span>
                </div>
                <span class="text-[8px] font-mono text-slate-600 uppercase tracking-[0.3em] border-l border-white/10 pl-3">Live Feed Active</span>
            </div>
        </header>

        <div class="absolute bottom-10 left-10 z-20 bg-black/40 backdrop-blur-md p-5 border border-white/10 rounded-sm">
            <h4 class="text-[8px] font-mono text-slate-500 uppercase tracking-[0.3em] mb-4">Bloques Monitoreados</h4>
            <div id="legend-items" class="grid grid-cols-2 gap-x-6 gap-y-2.5">
                </div>
        </div>
    </div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[500px] z-50 translate-x-full p-10 overflow-y-auto">
        <button onclick="closePanel()" class="mb-12 text-slate-500 hover:text-white transition-all text-[9px] font-bold tracking-[0.5em] flex items-center gap-2">
            <span>[</span> CLOSE ANALYSIS <span>]</span>
        </button>
        <div id="panel-content"></div>
    </aside>

    <script>
        const width = window.innerWidth, height = window.innerHeight;
        const svg = d3.select("#universe").append("svg").attr("width", width).attr("height", height);
        const BLOQUE_COLORS = {"USA": "#3b82f6", "Europa": "#fde047", "Rusia": "#ef4444", "China": "#f97316", "LATAM": "#d946ef", "Medio Oriente": "#10b981", "África": "#8b5cf6"};

        async function init() {
            try {
                const data = await d3.json("./latest_news.json?v=" + Date.now());
                
                // 1. Generar Leyenda
                const legend = document.getElementById('legend-items');
                Object.entries(BLOQUE_COLORS).forEach(([name, color]) => {
                    legend.innerHTML += `<div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full" style="background:${color}"></div><span class="text-[9px] font-mono text-slate-400 uppercase tracking-widest">${name}</span></div>`;
                });

                const centers = {
                    "Seguridad y Conflictos": {x: width * 0.25, y: height * 0.35, color: "#f43f5e"},
                    "Economía y Sanciones":   {x: width * 0.50, y: height * 0.55, color: "#fbbf24"},
                    "Energía y Recursos":    {x: width * 0.75, y: height * 0.35, color: "#22c55e"},
                    "Soberanía y Alianzas":  {x: width * 0.35, y: height * 0.75, color: "#a855f7"},
                    "Tecnología y Espacio":  {x: width * 0.65, y: height * 0.75, color: "#0ea5e9"}
                };

                let totalParticles = 0;
                const nodes = [];
                
                Object.keys(centers).forEach(catName => {
                    const c = centers[catName];
                    svg.append("circle").attr("cx", c.x).attr("cy", c.y).attr("r", 150).attr("class", "orbit-path");
                    svg.append("text").attr("x", c.x).attr("y", c.y + 180).attr("text-anchor", "middle").attr("class", "label-cat").text(catName);
                    
                    const catData = data.categorias.find(cat => cat.nombre === catName);
                    if(catData && catData.particulas) {
                        totalParticles += catData.particulas.length;
                        catData.particulas.forEach(p => {
                            nodes.push({ ...p, tx: c.x, ty: c.y, consensus: catData.consenso, catColor: c.color });
                        });
                    }
                });

                document.getElementById('news-count').innerText = `${totalParticles} Partículas en Órbita`;

                const simulation = d3.forceSimulation(nodes)
                    .force("x", d3.forceX(d => d.tx).strength(0.15))
                    .force("y", d3.forceY(d => d.ty).strength(0.15))
                    .force("collide", d3.forceCollide().radius(35))
                    .on("tick", () => { node.attr("transform", d => `translate(${d.x},${d.y})`); });

                const node = svg.selectAll(".node").data(nodes).join("g").attr("class", "particle").on("click", (e, d) => openPanel(d));

                node.append("circle")
                    .attr("r", d => 6 + (d.proximidad / 10))
                    .attr("fill", d => d.color_bloque)
                    .attr("stroke", "#fff").attr("stroke-width", 0.5)
                    .style("filter", d => `drop-shadow(0 0 10px ${d.color_bloque}88)`);

            } catch (err) { console.error("Error:", err); }
        }

        function openPanel(d) {
            document.getElementById('panel-content').innerHTML = `
                <div class="animate-in fade-in slide-in-from-right duration-500">
                    <div class="flex justify-between items-center mb-8">
                        <span style="background:${d.color_bloque}" class="text-[9px] font-black px-2 py-1 text-black uppercase tracking-widest">${d.bloque}</span>
                        <span class="font-mono text-2xl font-bold text-white">${d.proximidad}% <span class="text-[10px] text-slate-500 block text-right font-normal">ALINEACIÓN</span></span>
                    </div>
                    <h2 class="text-2xl font-extrabold leading-tight text-white mb-6">${d.titulo}</h2>
                    <div class="space-y-6">
                        <p class="text-lg leading-relaxed text-slate-200 font-light">${d.analisis_regional}</p>
                        <div class="bg-white/5 p-4 border-l-2" style="border-color:${d.catColor}">
                            <h4 class="text-[9px] uppercase tracking-[0.3em] text-slate-500 mb-2">Consenso de la Categoría</h4>
                            <p class="text-xs text-slate-400 italic font-serif">"${d.consensus}"</p>
                        </div>
                        <a href="${d.link}" target="_blank" class="block p-4 bg-white/5 hover:bg-sky-500/10 transition-all rounded border border-white/5 group">
                            <span class="text-[10px] text-sky-400 font-bold tracking-widest group-hover:underline">ORIGINAL SOURCE ↗</span>
                            <div class="text-[10px] text-slate-500 truncate mt-1">${d.link}</div>
                        </a>
                    </div>
                </div>`;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        function closePanel() { document.getElementById('side-panel').classList.add('translate-x-full'); }
        init();
    </script>
</body>
</html>
