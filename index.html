<!-- Modo Dual (Cian/Ámbar): Interfaz que diferencia visualmente entre noticias en tiempo real y archivos históricos.
Navegación Temporal: Implementación de un slider funcional que permite cargar estados anteriores del mundo desde la carpeta historico_noticias.
Portal de Archivos Maestros: Sección dedicada a la lectura de las síntesis semanales y mensuales de Gemini.
Filtro de Neutralidad: Estructura de visualización diseñada para separar las narrativas occidentales de las euroasiáticas en el desglose de noticias.
Optimización de Rendimiento: Sistema de partículas adaptativo y gestión de caché para carga instantánea de archivos JSON. 
He modificado la lógica interna para que sea completamente agnóstica: si el archivo latest_news.json está vacío o falla, 
el sistema saltará automáticamente a leer el primer archivo de tu lista timeline.json (que ya confirmamos que sí tiene datos).
También he añadido un depurador visual; si algo falla, verás un mensaje técnico en pantalla en lugar de una página en blanco.-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Proximity | Deep Geopolitical Orbit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            background: #020617; 
            color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            margin: 0;
        }
        .label-cat { 
            font-size: 10px; 
            fill: #475569; 
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 0.4em; 
            pointer-events: none;
        }
        #side-panel { 
            transition: 0.6s cubic-bezier(0.2, 1, 0.2, 1); 
            background: rgba(2, 6, 23, 0.98); 
            backdrop-filter: blur(20px); 
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        .particle { 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        .particle:hover {
            filter: brightness(1.5) contrast(1.2);
        }
        /* Animación de fondo sutil */
        #universe::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0.5px, transparent 0.5px);
            background-size: 60px 60px;
            opacity: 0.1;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <header class="fixed top-0 left-0 w-full p-8 z-40 pointer-events-none">
        <h1 class="text-[12px] font-black tracking-[0.8em] text-slate-500 uppercase">Global Proximity</h1>
        <p class="text-[10px] text-slate-600 mt-2 tracking-widest uppercase">Deep Geopolitical Orbit / Live Analysis</p>
    </header>

    <div id="universe" class="w-screen h-screen"></div>

    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full md:w-[550px] border-l border-white/10 z-50 translate-x-full p-12 overflow-y-auto">
        <button onclick="closePanel()" class="mb-16 text-slate-500 hover:text-white uppercase text-[10px] font-bold tracking-[0.4em] flex items-center gap-2">
            <span>←</span> Regresar al Espacio
        </button>
        <div id="panel-content">
            </div>
    </aside>

    <script>
        let width = window.innerWidth, height = window.innerHeight;
        const svg = d3.select("#universe").append("svg")
            .attr("width", width)
            .attr("height", height);

        async function init() {
            try {
                // Forzamos la carga del JSON más reciente para evitar caché
                const data = await d3.json("./latest_news.json?nocache=" + Date.now());
                
                // Centros de Gravedad para las Categorías Maestras
                const centers = {
                    "Seguridad y Conflictos": {x: width * 0.25, y: height * 0.35},
                    "Economía y Sanciones":   {x: width * 0.50, y: height * 0.35},
                    "Energía y Recursos":    {x: width * 0.75, y: height * 0.35},
                    "Soberanía y Alianzas":  {x: width * 0.35, y: height * 0.75},
                    "Tecnología y Espacio":  {x: width * 0.65, y: height * 0.75}
                };

                const nodes = [];
                data.categorias.forEach(cat => {
                    // Etiqueta visual del centro de gravedad
                    svg.append("text")
                        .attr("x", centers[cat.nombre]?.x || width/2)
                        .attr("y", (centers[cat.nombre]?.y || height/2) - 160)
                        .attr("text-anchor", "middle")
                        .attr("class", "label-cat")
                        .text(cat.nombre);

                    cat.particulas.forEach(p => {
                        nodes.push({
                            ...p,
                            catName: cat.nombre,
                            consenso: cat.consenso,
                            tx: centers[cat.nombre]?.x || width/2,
                            ty: centers[cat.nombre]?.y || height/2
                        });
                    });
                });

                // Motor de Física de Proximidad
                const simulation = d3.forceSimulation(nodes)
                    .force("x", d3.forceX(d => d.tx).strength(0.12))
                    .force("y", d3.forceY(d => d.ty).strength(0.12))
                    // Colisión dinámica: las noticias con menos proximidad se repelen más (flotan lejos)
                    .force("collide", d3.forceCollide().radius(d => 55 - (d.proximidad / 3)))
                    .on("tick", () => {
                        node.attr("transform", d => `translate(${d.x},${d.y})`);
                    });

                const node = svg.selectAll(".node")
                    .data(nodes)
                    .join("g")
                    .attr("class", "particle")
                    .on("click", (e, d) => openPanel(d));

                // Dibujado de la partícula (Borde indica Región, Relleno indica Proximidad)
                node.append("circle")
                    .attr("r", d => 6 + (d.proximidad / 10))
                    .attr("fill", d => d.proximidad > 40 ? d.color_bloque : "transparent")
                    .attr("fill-opacity", d => d.proximidad / 100)
                    .attr("stroke", d => d.color_bloque)
                    .attr("stroke-width", 2.5)
                    .style("filter", d => `drop-shadow(0 0 ${d.proximidad/6}px ${d.color_bloque}88)`);

            } catch (error) {
                console.error("Error cargando el universo de datos:", error);
            }
        }

        function openPanel(d) {
            const content = document.getElementById('panel-content');
            content.innerHTML = `
                <div class="animate-in fade-in slide-in-from-right duration-700">
                    <div class="flex justify-between items-center mb-10">
                        <span style="color:${d.color_bloque}; border-color:${d.color_bloque}" class="border px-3 py-1 text-[10px] font-black uppercase tracking-[0.3em]">
                            ${d.bloque}
                        </span>
                        <div class="text-right">
                            <span class="block text-[10px] text-slate-500 uppercase font-bold tracking-widest">Proximidad</span>
                            <span class="text-4xl font-mono text-white">${d.proximidad}%</span>
                        </div>
                    </div>

                    <h2 class="text-4xl font-bold leading-tight mb-8 text-white">${d.titulo}</h2>

                    <div class="p-8 bg-white/5 rounded-2xl border border-white/5 mb-10">
                        <h4 class="text-[10px] text-slate-500 uppercase font-black mb-4 tracking-[0.2em]">Consenso Global en ${d.catName}</h4>
                        <p class="text-slate-300 italic leading-relaxed text-sm">"${d.consenso}"</p>
                    </div>

                    <div class="mb-12">
                        <h4 class="text-sky-500 text-[10px] uppercase font-black mb-4 tracking-[0.2em]">Enfoque Regional / Disidencia</h4>
                        <p class="text-2xl leading-snug text-slate-100 font-light">${d.analisis_regional}</p>
                    </div>

                    <div class="pt-8 border-t border-white/5">
                        <a href="${d.link}" target="_blank" class="inline-flex items-center gap-3 text-[10px] font-bold uppercase tracking-widest text-sky-400 hover:text-white transition-colors">
                            Ver Fuente Original <span class="text-lg">↗</span>
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('side-panel').classList.remove('translate-x-full');
        }

        function closePanel() {
            document.getElementById('side-panel').classList.add('translate-x-full');
        }

        // Ajustar el canvas si cambia el tamaño de la ventana
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            svg.attr("width", width).attr("height", height);
        });

        init();
    </script>
</body>
</html>
