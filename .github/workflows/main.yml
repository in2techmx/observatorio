name: Proximity Engine Intelligence Pipeline

on:
  schedule:
    # Radar t√°ctico - cada 6 horas (minuto 0)
    - cron: '0 */6 * * *'
    # S√≠ntesis semanal - domingos a medianoche UTC
    - cron: '0 0 * * 0'
  
  # Trigger manual desde la web de GitHub
  workflow_dispatch:
    inputs:
      task:
        description: 'Tipo de an√°lisis'
        required: false
        default: 'tactical'
        type: choice
        options:
          - tactical
          - weekly
          - both
      force:
        description: 'Forzar ejecuci√≥n incluso si hay errores previos'
        required: false
        default: false
        type: boolean

  # Trigger en push a main (solo para desarrollo)
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  intelligence-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necesario para push
      pages: write     # Si usas GitHub Pages despu√©s
      id-token: write  # Para OIDC si es necesario
    
    # Variables de entorno
    env:
      PYTHON_VERSION: '3.10'
      CACHE_DAYS: '7'
      MAX_RETRIES: '3'
    
    # Estrategia de fallos
    strategy:
      matrix:
        python-version: ['3.10']
      fail-fast: false  # No fallar todo si un paso falla
    
    steps:
      # --------------------------------------------------------------------
      # 1. PREPARACI√ìN DEL ENTORNO
      # --------------------------------------------------------------------
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Traer todo el historial
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Cache autom√°tico de pip
          cache-dependency-path: |
            requirements.txt
            setup.py
            pyproject.toml
      
      # --------------------------------------------------------------------
      # 2. INSTALACI√ìN CON DEPENDENCIAS COMPLETAS
      # --------------------------------------------------------------------
      - name: Actualizar pip e instalar dependencias
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # Instalar desde requirements.txt si existe
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else:
            # Dependencias b√°sicas
            pip install google-genai
            pip install numpy
            pip install beautifulsoup4
            pip install requests
            pip install lxml
            pip install urllib3
            pip install python-dateutil
            pip install pyyaml
          
          # Verificar instalaci√≥n
          python -c "import google.generativeai as genai; print('‚úì Google AI instalado')"
          python -c "import requests; print('‚úì Requests instalado')"
      
      # --------------------------------------------------------------------
      # 3. VERIFICACI√ìN DE ARCHIVOS
      # --------------------------------------------------------------------
      - name: Verificar archivos del sistema
        id: verify-files
        run: |
          echo "üìÅ Verificando estructura del proyecto..."
          
          REQUIRED_FILES=("collector.py")
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file encontrado"
            else
              echo "‚ùå $file NO encontrado"
              exit 1
            fi
          done
          
          echo "files_ok=true" >> $GITHUB_OUTPUT
      
      # --------------------------------------------------------------------
      # 4. EJECUCI√ìN DEL RADAR T√ÅCTICO (SIEMPRE O SEG√öN INPUT)
      # --------------------------------------------------------------------
      - name: Ejecutar Radar de Vigilancia T√°ctico
        id: tactical-radar
        if: |
          steps.verify-files.outputs.files_ok == 'true' &&
          (github.event.schedule == '0 */6 * * *' ||
           github.event.inputs.task == 'tactical' ||
           github.event.inputs.task == 'both' ||
           github.event_name == 'push')
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üöÄ Iniciando Radar T√°ctico"
          echo "API Key configurada: $(if [ -n "$GEMINI_API_KEY" ]; then echo "‚úÖ"; else echo "‚ùå Falta API Key"; exit 1; fi)"
          
          # Ejecutar con logging detallado
          python collector.py 2>&1 | tee tactical_execution.log
          
          EXIT_CODE=$?
          
          # Verificar resultados
          if [ -f "gravity_carousel.json" ]; then
            FILESIZE=$(wc -c < gravity_carousel.json)
            PARTICLES=$(python -c "import json; data=json.load(open('gravity_carousel.json')); print(sum(len(area['particulas']) for area in data.get('carousel', [])))" 2>/dev/null || echo "0")
            
            echo "üìä Radar completado: $PARTICLES part√≠culas, $FILESIZE bytes"
            echo "tactical_success=true" >> $GITHUB_OUTPUT
            echo "particles_count=$PARTICLES" >> $GITHUB_OUTPUT
          else
            echo "‚ùå ERROR: No se gener√≥ gravity_carousel.json"
            echo "tactical_success=false" >> $GITHUB_OUTPUT
            exit $EXIT_CODE
          fi
      
      # --------------------------------------------------------------------
      # 5. S√çNTESIS ESTRAT√âGICA SEMANAL (SOLO DOMINGOS O MANUAL)
      # --------------------------------------------------------------------
      - name: Ejecutar S√≠ntesis Estrat√©gica Semanal
        id: weekly-synthesis
        if: |
          steps.verify-files.outputs.files_ok == 'true' &&
          (github.event.schedule == '0 0 * * 0' ||
           github.event.inputs.task == 'weekly' ||
           github.event.inputs.task == 'both') &&
          (steps.tactical-radar.outputs.tactical_success == 'true' || 
           github.event.inputs.force == 'true')
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "üìà Iniciando S√≠ntesis Estrat√©gica Semanal"
          
          # Verificar si existe el agregador
          if [ -f "aggregator.py" ]; then
            python aggregator.py 2>&1 | tee weekly_execution.log
            
            # Verificar resultados
            if find historico_noticias/semanal -name "*.json" -newer /proc/uptime 2>/dev/null | grep -q .; then
              echo "weekly_success=true" >> $GITHUB_OUTPUT
              echo "‚úÖ S√≠ntesis semanal completada"
            else
              echo "weekly_success=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è No se generaron nuevos reportes semanales"
            fi
          else
            echo "weekly_success=skipped" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Aggregator no encontrado, saltando s√≠ntesis..."
          fi
      
      # --------------------------------------------------------------------
      # 6. LIMPIEZA Y MANTENIMIENTO INTELIGENTE
      # --------------------------------------------------------------------
      - name: Mantenimiento del Sistema
        if: always()  # Siempre ejecutar, incluso si fallan pasos anteriores
        run: |
          echo "üßπ Realizando mantenimiento del sistema..."
          
          # 1. Limpiar cach√© antigua
          if [ -d "vector_cache" ]; then
            find vector_cache -name "*.bin" -mtime +${{ env.CACHE_DAYS }} -delete 2>/dev/null || true
            COUNT=$(find vector_cache -name "*.bin" | wc -l)
            echo "üì¶ Cache actual: $COUNT vectores"
          fi
          
          # 2. Limitar tama√±o del hist√≥rico diario (mantener √∫ltimos 30 d√≠as)
          if [ -d "historico_noticias/diario" ]; then
            find historico_noticias/diario -name "*.json" -mtime +30 -delete 2>/dev/null || true
          fi
          
          # 3. Crear archivo de estado del sistema
          cat > system_status.json << EOF
          {
            "last_execution": "$(date -Iseconds)",
            "workflow": "${{ github.workflow }}",
            "event": "${{ github.event_name }}",
            "tactical_status": "${{ steps.tactical-radar.outputs.tactical_success || 'not_run' }}",
            "weekly_status": "${{ steps.weekly-synthesis.outputs.weekly_success || 'not_run' }}",
            "particles_generated": "${{ steps.tactical-radar.outputs.particles_count || 0 }}"
          }
          EOF
      
      # --------------------------------------------------------------------
      # 7. PUBLICACI√ìN SEGURA EN GIT
      # --------------------------------------------------------------------
      - name: Publicar Inteligencia en el Repositorio
        id: git-publish
        # Solo publicar si el radar fue exitoso O si se fuerza manualmente
        if: |
          steps.tactical-radar.outputs.tactical_success == 'true' ||
          github.event.inputs.force == 'true'
        run: |
          echo "üíæ Preparando publicaci√≥n de inteligencia..."
          
          # Configurar identidad del bot
          git config --global user.name 'Proximity Intelligence Engine'
          git config --global user.email 'engine@proximity.ai'
          git config --global pull.rebase false
          git config --global push.default simple
          
          # Mostrar cambios
          echo "üìà Archivos modificados:"
          git status --short || echo "No se pudo ver estado git"
          
          # A√±adir archivos nuevos/modificados
          git add --all || echo "No hay cambios para a√±adir"
          
          # Crear mensaje de commit contextual
          COMMIT_TYPE="üîÑ"
          COMMIT_SUFFIX=""
          
          if [[ "${{ github.event.schedule }}" == "0 0 * * 0" ]]; then
            COMMIT_TYPE="üìä"
            COMMIT_SUFFIX=" + S√≠ntesis Semanal"
          elif [[ "${{ github.event.inputs.task }}" == "weekly" ]]; then
            COMMIT_TYPE="üìà"
            COMMIT_SUFFIX=" + An√°lisis Estrat√©gico"
          fi
          
          COMMIT_MSG="$COMMIT_TYPE Actualizaci√≥n Autom√°tica: $(date '+%Y-%m-%d %H:%M UTC')$COMMIT_SUFFIX"
          
          # Crear commit solo si hay cambios
          if ! git diff --cached --quiet; then
            git commit -m "$COMMIT_MSG" \
                       -m "ü§ñ Ejecutado autom√°ticamente por GitHub Actions" \
                       -m "üìÖ Workflow: ${{ github.workflow }}" \
                       -m "‚ö° Evento: ${{ github.event_name }}" \
                       -m "üîó Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            echo "‚úÖ Commit creado"
            echo "has_commit=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è No hay cambios para commit"
            echo "has_commit=false" >> $GITHUB_OUTPUT
          fi
      
      # --------------------------------------------------------------------
      # 8. SINCRONIZACI√ìN SEGURA CON EL REPOSITORIO
      # --------------------------------------------------------------------
      - name: Sincronizar con Repositorio Remoto
        id: git-sync
        if: steps.git-publish.outputs.has_commit == 'true'
        run: |
          echo "üåê Sincronizando con repositorio remoto..."
          
          # Estrategia de sincronizaci√≥n robusta con reintentos
          for ATTEMPT in {1..3}; do
            echo "üîÑ Intento $ATTEMPT de sincronizaci√≥n..."
            
            # 1. Obtener √∫ltimos cambios
            if git pull origin main --no-edit; then
              echo "‚úÖ Pull exitoso"
            else
              echo "‚ö†Ô∏è Pull con conflictos, intentando estrategia alternativa..."
              git stash || true
              git pull origin main --strategy-option=ours || git pull origin main --rebase || true
              git stash pop || true
            fi
            
            # 2. Intentar push
            if git push origin main; then
              echo "‚úÖ Push exitoso"
              echo "sync_success=true" >> $GITHUB_OUTPUT
              break
            else
              echo "‚ùå Push fall√≥, reintentando en 10 segundos..."
              sleep 10
              
              if [ $ATTEMPT -eq 3 ]; then
                echo "sync_success=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è Todos los intentos de push fallaron"
              fi
            fi
          done
      
      # --------------------------------------------------------------------
      # 9. REPORTE DE EJECUCI√ìN
      # --------------------------------------------------------------------
      - name: Generar Reporte de Ejecuci√≥n
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = "${{ job.status }}" === "success";
            const tacticalSuccess = "${{ steps.tactical-radar.outputs.tactical_success }}" === "true";
            const weeklySuccess = "${{ steps.weekly-synthesis.outputs.weekly_success }}" === "true";
            const particles = "${{ steps.tactical-radar.outputs.particles_count }}" || "0";
            
            let message = `## üéØ Proximity Engine - Ejecuci√≥n Completada\n\n`;
            
            message += `**Estado:** ${success ? '‚úÖ √âXITO' : '‚ö†Ô∏è CON PROBLEMAS'}\n`;
            message += `**Radar T√°ctico:** ${tacticalSuccess ? '‚úÖ' : '‚ùå'}\n`;
            message += `**S√≠ntesis Semanal:** ${weeklySuccess ? '‚úÖ' : weeklySuccess === 'skipped' ? '‚è≠Ô∏è' : '‚ùå'}\n`;
            message += `**Part√≠culas Generadas:** ${particles}\n`;
            message += `**Evento:** ${context.eventName}\n\n`;
            
            message += `üìä **M√©tricas:**\n`;
            message += `- Workflow: ${context.workflow}\n`;
            message += `- Ejecuci√≥n: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n`;
            message += `- Hora: ${new Date().toISOString()}\n\n`;
            
            message += `üìÅ **Archivos Generados:**\n`;
            
            if (tacticalSuccess) {
              message += `- \`gravity_carousel.json\` (Radar principal)\n`;
              message += `- \`executive_summary.json\` (Resumen ejecutivo)\n`;
            }
            
            if (weeklySuccess === 'true') {
              message += `- \`historico_noticias/semanal/*.json\` (S√≠ntesis semanal)\n`;
            }
            
            // Crear comentario en el commit
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });
            
            // Opcional: Crear issue si hay fallos cr√≠ticos
            if (!tacticalSuccess && context.eventName !== 'workflow_dispatch') {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Fallo en Proximity Engine - ${new Date().toISOString().split('T')[0]}`,
                body: `El radar t√°ctico fall√≥ en la ejecuci√≥n autom√°tica.\n\n${message}`,
                labels: ['bug', 'automation']
              });
            }
      
      # --------------------------------------------------------------------
      # 10. NOTIFICACIONES (OPCIONAL)
      # --------------------------------------------------------------------
      - name: Enviar Notificaci√≥n a Slack/Discord
        if: always() && github.event_name != 'push'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: workflow,job,commit,repo,ref,author,took
          channel: '#alerts'  # Cambia por tu canal
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}  # Configurar en secrets

  # --------------------------------------------------------------------
  # JOB ADICIONAL: Validaci√≥n de Calidad de Datos
  # --------------------------------------------------------------------
  data-quality-check:
    runs-on: ubuntu-latest
    needs: intelligence-pipeline
    if: always() && needs.intelligence-pipeline.result == 'success'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Validar Calidad de Datos Generados
        run: |
          echo "üîç Validando calidad de datos..."
          
          # Verificar que gravity_carousel.json sea JSON v√°lido
          if [ -f "gravity_carousel.json" ]; then
            python -m json.tool gravity_carousel.json > /dev/null && echo "‚úÖ JSON v√°lido"
            
            # Validar estructura b√°sica
            python << 'EOF'
            import json
            with open('gravity_carousel.json') as f:
                data = json.load(f)
            
            required_keys = ['carousel', 'meta']
            for key in required_keys:
                if key not in data:
                    print(f"‚ùå Falta clave requerida: {key}")
                    exit(1)
            
            print(f"‚úÖ Estructura v√°lida: {len(data['carousel'])} √°reas, {sum(len(a.get('particulas', [])) for a in data['carousel'])} part√≠culas")
            EOF
          fi
