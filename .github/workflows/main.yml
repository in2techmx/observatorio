name: Proximity Engine Intelligence Pipeline

on:
  schedule:
    - cron: '0 */6 * * *'
    - cron: '0 0 * * 0'
  
  workflow_dispatch:
    inputs:
      task:
        description: 'Tipo de anÃ¡lisis'
        required: false
        default: 'tactical'
        type: choice
        options:
          - tactical
          - weekly
          - both

jobs:
  intelligence-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # EVITA EJECUCIONES PARALELAS - CRÃTICO
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    
    env:
      PYTHON_VERSION: '3.10'
    
    steps:
      # ----------------------------------------------------------------
      # 1. CHECKOUT
      # ----------------------------------------------------------------
      - name: Checkout del repositorio
        uses: actions/checkout@v4
      
      # ----------------------------------------------------------------
      # 2. CONFIGURAR PYTHON (SIN CACHE PARA EVITAR PROBLEMAS)
      # ----------------------------------------------------------------
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # ----------------------------------------------------------------
      # 3. PREPARAR DIRECTORIOS DE FORMA SEGURA
      # ----------------------------------------------------------------
      - name: Preparar estructura de directorios
        id: prepare-dirs
        run: |
          echo "ðŸ› ï¸ Preparando estructura de directorios..."
          
          # FORMA SEGURA: Crear si no existe, ignorar si ya existe
          mkdir vector_cache 2>/dev/null || true
          mkdir -p historico_noticias/diario 2>/dev/null || true
          mkdir -p historico_noticias/semanal 2>/dev/null || true
          
          # Verificar permisos (sin fallar)
          chmod 755 vector_cache 2>/dev/null || echo "âš ï¸ No se pudieron cambiar permisos de vector_cache"
          chmod -R 755 historico_noticias 2>/dev/null || echo "âš ï¸ No se pudieron cambiar permisos de historico_noticias"
          
          # Listar para verificaciÃ³n
          echo "ðŸ“ Estructura actual:"
          ls -la
          echo "âœ… Directorios preparados"
      
      # ----------------------------------------------------------------
      # 4. INSTALAR DEPENDENCIAS
      # ----------------------------------------------------------------
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          
          # Instalar directamente sin requirements.txt para evitar problemas
          pip install google-genai==0.3.0
          pip install requests==2.31.0
          pip install beautifulsoup4==4.12.0
          pip install lxml==4.9.0
          pip install numpy==1.24.0
      
      # ----------------------------------------------------------------
      # 5. EJECUTAR COLECTOR (CON MECANISMO DE FALLBACK)
      # ----------------------------------------------------------------
      - name: Ejecutar Proximity Collector
        id: run-collector
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸš€ Iniciando Proximity Collector..."
          
          # INTENTO 1: EjecuciÃ³n normal
          echo "ðŸ”§ Intento 1: EjecuciÃ³n estÃ¡ndar"
          python collector.py 2>&1 | tee collector_output.log
          
          COLLECTOR_EXIT=$?
          
          # Si falla, intentar con entorno alternativo
          if [ $COLLECTOR_EXIT -ne 0 ]; then
            echo "âš ï¸ FallÃ³ intento 1, probando entorno alternativo..."
            
            # Crear directorios dentro del script como fallback
            python -c "
import os
try:
    os.makedirs('vector_cache', exist_ok=True)
    os.makedirs('historico_noticias/diario', exist_ok=True)
    print('âœ… Directorios creados desde Python')
except Exception as e:
    print(f'âš ï¸ Error creando directorios: {e}')
    # Usar directorio temporal
    import tempfile
    temp_dir = tempfile.mkdtemp()
    print(f'ðŸ“ Usando directorio temporal: {temp_dir}')
            " 2>&1
            
            # INTENTO 2: Con timeout
            echo "ðŸ”§ Intento 2: Con timeout extendido"
            timeout 300 python collector.py 2>&1 | tee -a collector_output.log
            COLLECTOR_EXIT=$?
          fi
          
          # Evaluar resultado
          if [ $COLLECTOR_EXIT -eq 0 ] && [ -f "gravity_carousel.json" ]; then
            echo "âœ… Collector ejecutado exitosamente"
            echo "collector_success=true" >> $GITHUB_OUTPUT
            
            # Mostrar estadÃ­sticas
            echo "ðŸ“Š Resumen de ejecuciÃ³n:"
            python -c "
import json, os
try:
    with open('gravity_carousel.json') as f:
        data = json.load(f)
    areas = len(data.get('carousel', []))
    particles = sum(len(a.get('particulas', [])) for a in data.get('carousel', []))
    print(f'  â€¢ Ãreas procesadas: {areas}')
    print(f'  â€¢ PartÃ­culas generadas: {particles}')
except Exception as e:
    print(f'  â€¢ Error leyendo resultados: {e}')
            "
          else
            echo "âŒ Collector fallÃ³ con cÃ³digo: $COLLECTOR_EXIT"
            echo "collector_success=false" >> $GITHUB_OUTPUT
            
            # Mostrar logs de error
            echo "=== ÃšLTIMAS 20 LÃNEAS DEL LOG ==="
            tail -20 collector_output.log || echo "No hay logs disponibles"
          fi
      
      # ----------------------------------------------------------------
      # 6. EJECUTAR AGREGADOR (OPCIONAL)
      # ----------------------------------------------------------------
      - name: Ejecutar Agregador Semanal
        id: run-aggregator
        if: |
          steps.run-collector.outputs.collector_success == 'true' &&
          (github.event.schedule == '0 0 * * 0' || 
           github.event.inputs.task == 'weekly' || 
           github.event.inputs.task == 'both')
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸ“ˆ Ejecutando agregador semanal..."
          
          if [ -f "aggregator.py" ]; then
            python aggregator.py 2>&1 | tee aggregator_output.log
            
            if [ $? -eq 0 ]; then
              echo "âœ… Agregador ejecutado exitosamente"
              echo "aggregator_success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Agregador fallÃ³"
              echo "aggregator_success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â­ï¸ aggregator.py no encontrado"
            echo "aggregator_success=skipped" >> $GITHUB_OUTPUT
          fi
      
      # ----------------------------------------------------------------
      # 7. COMMIT Y PUSH (SOLO SI HUBO Ã‰XITO)
      # ----------------------------------------------------------------
      - name: Commit y Push de Resultados
        if: steps.run-collector.outputs.collector_success == 'true'
        run: |
          echo "ðŸ’¾ Preparando commit de resultados..."
          
          # Configurar git
          git config --global user.name 'Proximity Engine Bot'
          git config --global user.email 'bot@proximity.ai'
          
          # AÃ±adir solo archivos de datos
          git add gravity_carousel.json 2>/dev/null || echo "âš ï¸ No se pudo aÃ±adir gravity_carousel.json"
          git add executive_summary.json 2>/dev/null || echo "âš ï¸ No se pudo aÃ±adir executive_summary.json"
          git add historico_noticias/ 2>/dev/null || echo "âš ï¸ No se pudo aÃ±adir historico_noticias/"
          
          # Verificar si hay cambios
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No hay cambios para commit"
          else
            # Crear commit
            git commit -m "ðŸ¤– ActualizaciÃ³n automÃ¡tica: $(date +'%Y-%m-%d %H:%M UTC')"
            
            # Pull con estrategia segura
            git pull origin main --strategy-option=ours --no-edit 2>/dev/null || \
            git pull origin main --rebase 2>/dev/null || \
            echo "âš ï¸ No se pudo hacer pull, continuando..."
            
            # Push con reintentos
            for i in {1..3}; do
              echo "ðŸ”„ Intento $i de push..."
              if git push origin main; then
                echo "âœ… Push exitoso"
                break
              else
                echo "âš ï¸ Push fallÃ³, esperando 5s..."
                sleep 5
                git pull origin main --rebase 2>/dev/null || true
              fi
            done
          fi
      
      # ----------------------------------------------------------------
      # 8. LIMPIEZA Y REPORTE FINAL
      # ----------------------------------------------------------------
      - name: Limpieza y reporte final
        if: always()
        run: |
          echo "ðŸ§¹ Limpiando archivos temporales..."
          rm -f collector_output.log aggregator_output.log 2>/dev/null || true
          
          echo "ðŸ“‹ REPORTE FINAL DE EJECUCIÃ“N:"
          echo "----------------------------------------"
          echo "Collector: ${{ steps.run-collector.outputs.collector_success || 'unknown' }}"
          echo "Agregador: ${{ steps.run-aggregator.outputs.aggregator_success || 'not_run' }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Evento: ${{ github.event_name }}"
          echo "Fecha: $(date)"
          echo "----------------------------------------"
